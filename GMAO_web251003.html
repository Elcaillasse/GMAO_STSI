<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Prototype GMAO – Modèle HTML</title>
  <style>
    :root{
      --bg:#0f172a;          /* slate-900 */
      --panel:#111827;       /* gray-900 */
      --muted:#1f2937;       /* gray-800 */
      --card:#0b1220;        /* dark card */
      --ink:#e5e7eb;         /* gray-200 */
      --ink-dim:#9ca3af;     /* gray-400 */
      --brand:#22d3ee;       /* cyan-400 */
      --accent:#a78bfa;      /* violet-400 */
      --ok:#10b981;          /* emerald */
      --warn:#f59e0b;        /* amber */
      --bad:#ef4444;         /* red */
      --shadow:0 10px 25px rgba(0,0,0,.25), 0 1px 0 rgba(255,255,255,.03) inset;
      --radius:16px;
    }
    :root[data-theme="light"]{
      --bg:#f1f5f9;
      --panel:#ffffff;
      --muted:#e2e8f0;
      --card:#f8fafc;
      --ink:#0f172a;
      --ink-dim:#475569;
      --brand:#0ea5e9;
      --accent:#6366f1;
      --ok:#059669;
      --warn:#d97706;
      --bad:#dc2626;
      --shadow:0 12px 28px rgba(15,23,42,.12), 0 1px 0 rgba(15,23,42,.04) inset;
    }
    *{box-sizing:border-box}
    [hidden]{display:none!important}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 600px at 80% -10%,rgba(167,139,250,.15),transparent),
                          radial-gradient(900px 500px at -20% 10%,rgba(34,211,238,.12),transparent),
                          var(--bg);color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,"Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji";}
    :root[data-theme="light"] body{background:radial-gradient(1200px 600px at 80% -10%,rgba(99,102,241,.14),transparent),
                                   radial-gradient(900px 500px at -20% 10%,rgba(14,165,233,.12),transparent),
                                   var(--bg);}
    a{color:inherit;text-decoration:none}
    a:focus-visible,button:focus-visible,input:focus-visible,select:focus-visible,textarea:focus-visible{
      outline:2px solid var(--accent);
      outline-offset:2px;
    }
    .app{display:grid;grid-template-columns:260px 1fr;grid-template-rows:64px 1fr;height:100vh;gap:16px;padding:16px}
    header{grid-column:1/3;height:64px;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.06);backdrop-filter:blur(6px);border-radius:var(--radius);display:flex;align-items:center;justify-content:space-between;padding:0 16px;box-shadow:var(--shadow)}
    :root[data-theme="light"] header,
    :root[data-theme="light"] nav,
    :root[data-theme="light"] main{background:linear-gradient(180deg,rgba(15,23,42,.05),rgba(15,23,42,.02));border:1px solid rgba(15,23,42,.08);}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:36px;height:36px;border-radius:12px;background:linear-gradient(135deg,var(--brand),var(--accent));display:grid;place-items:center;box-shadow:0 6px 20px rgba(34,211,238,.3)}
    .logo svg{filter:drop-shadow(0 2px 6px rgba(0,0,0,.3))}
    .brand h1{font-size:16px;letter-spacing:.3px;margin:0;font-weight:700}
    .header-actions{display:flex;gap:8px;align-items:center}
    .btn{background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);padding:8px 12px;border-radius:12px;color:var(--ink);display:inline-flex;gap:8px;align-items:center;cursor:pointer;box-shadow:var(--shadow)}
    .btn.primary{background:linear-gradient(180deg,rgba(34,211,238,.25),rgba(34,211,238,.08));border-color:rgba(34,211,238,.3)}
    :root[data-theme="light"] .btn{background:linear-gradient(180deg,rgba(148,163,184,.12),rgba(148,163,184,.05));border:1px solid rgba(148,163,184,.26)}
    :root[data-theme="light"] .btn.primary{background:linear-gradient(180deg,rgba(14,165,233,.22),rgba(14,165,233,.08));border-color:rgba(14,165,233,.3)}
    .btn:active{transform:translateY(1px)}

    nav{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);padding:12px;box-shadow:var(--shadow)}
    .search{display:flex;gap:8px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:8px}
    :root[data-theme="light"] .search{background:rgba(148,163,184,.12);border:1px solid rgba(148,163,184,.28)}
    .search input{flex:1;background:transparent;border:0;outline:0;color:var(--ink)}
    .menu{margin-top:12px;display:flex;flex-direction:column;gap:6px;}
    .menu a{padding:10px 12px;border-radius:10px;border:1px solid transparent;display:flex;gap:10px;align-items:center}
    .menu a.active, .menu a:hover{background:rgba(167,139,250,.1);border-color:rgba(167,139,250,.25)}

    main{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);overflow:auto}
    .section{display:none;}
    .section.active{display:block}

    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:14px;box-shadow:var(--shadow)}
    :root[data-theme="light"] .card{border:1px solid rgba(15,23,42,.08)}
    .card h3{margin:0 0 6px 0;font-size:12px;color:var(--ink-dim);font-weight:600;letter-spacing:.3px;text-transform:uppercase}
    .card .value{font-size:24px;font-weight:800}
    .card.backlog-card{display:flex;flex-direction:column;gap:12px}
    .card.backlog-card .table-wrapper{flex:1;min-height:440px;overflow:auto}
    .tag{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid rgba(255,255,255,.12)}
    .tag.ok{background:rgba(16,185,129,.15);border-color:rgba(16,185,129,.35)}
    .tag.warn{background:rgba(245,158,11,.15);border-color:rgba(245,158,11,.35)}
    .tag.bad{background:rgba(239,68,68,.15);border-color:rgba(239,68,68,.35)}

    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th,td{padding:10px}
    thead th{text-align:left;font-size:12px;color:var(--ink-dim);text-transform:uppercase;letter-spacing:.4px}
    tbody tr{background:var(--panel);border:1px solid rgba(255,255,255,.06)}
    :root[data-theme="light"] tbody tr{border:1px solid rgba(15,23,42,.08)}
    tbody tr td:first-child{border-radius:12px 0 0 12px}
    tbody tr td:last-child{border-radius:0 12px 12px 0}
    .status{font-weight:700}
    .status.ok{color:var(--ok)}
    .status.warn{color:var(--warn)}
    .status.bad{color:var(--bad)}
    tbody tr.clickable{cursor:pointer;transition:background .2s ease,transform .2s ease}
    tbody tr.clickable:hover{background:rgba(167,139,250,.12);transform:translateY(-1px)}
    :root[data-theme="light"] tbody tr.clickable:hover{background:rgba(99,102,241,.12)}
    tbody tr.clickable:focus-visible{outline:2px solid var(--accent);outline-offset:2px}

    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:12px 0}
    .toolbar .input, .toolbar select{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:8px 10px;color:var(--ink)}
    :root:not([data-theme="light"]) .toolbar select{background:var(--panel);border:1px solid rgba(255,255,255,.14)}
    :root[data-theme="light"] .toolbar .input,
    :root[data-theme="light"] .toolbar select{background:rgba(148,163,184,.12);border:1px solid rgba(148,163,184,.28)}
    .toolbar select option{background:var(--panel);color:var(--ink)}
    :root[data-theme="light"] .toolbar select option{background:rgba(226,232,240,.95);color:var(--ink)}

    /* modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);padding:24px}
    .modal.open{display:flex}
    .modal .sheet{width:min(720px,100%);background:var(--panel);border:1px solid rgba(255,255,255,.1);border-radius:18px;box-shadow:var(--shadow)}
    :root[data-theme="light"] .modal .sheet{border:1px solid rgba(15,23,42,.12)}
    .modal header{grid-column:auto;background:transparent;border:0;box-shadow:none;padding:16px}
    .modal .content{padding:16px}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-size:12px;color:var(--ink-dim)}
    .field input,.field select,.field textarea{background:rgba(15,23,42,.6);border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:8px 10px;color:var(--ink)}
    .field textarea{min-height:140px;resize:vertical}
    .field select option{background:var(--panel);color:var(--ink)}
    :root[data-theme="light"] .field input,
    :root[data-theme="light"] .field select,
    :root[data-theme="light"] .field textarea{background:rgba(226,232,240,.6);border:1px solid rgba(148,163,184,.4)}
    :root[data-theme="light"] .field select option{background:rgba(226,232,240,.95);color:var(--ink)}
    .actions{display:flex;gap:8px;justify-content:flex-end;padding:0 16px 16px}

    .attachments .attachment-actions{display:flex;flex-wrap:wrap;gap:8px}
    .attachment-list{list-style:none;margin:8px 0 0;padding:0;display:grid;gap:6px}
    .attachment-item{display:flex;align-items:center;justify-content:space-between;gap:12px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:8px 10px;font-size:13px}
    :root[data-theme="light"] .attachment-item{background:rgba(148,163,184,.12);border:1px solid rgba(148,163,184,.28)}
    .attachment-info{display:flex;flex-direction:column;gap:2px}
    .attachment-name{font-weight:600}
    .attachment-meta{font-size:12px;color:var(--ink-dim)}
    .attachment-remove{background:transparent;border:0;color:var(--ink-dim);cursor:pointer;padding:4px;border-radius:8px;line-height:1;font-size:16px}
    .attachment-remove:hover{color:var(--bad);background:rgba(239,68,68,.12)}
    :root[data-theme="light"] .attachment-remove:hover{background:rgba(220,38,38,.12)}
    .attachment-empty{font-size:12px;color:var(--ink-dim)}
    .camera-preview{margin-top:12px;display:flex;flex-direction:column;gap:12px;background:rgba(15,23,42,.6);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:12px}
    :root[data-theme="light"] .camera-preview{background:rgba(226,232,240,.6);border:1px solid rgba(148,163,184,.4)}
    .camera-preview video{width:100%;max-height:240px;border-radius:12px;background:black}
    .camera-actions{display:flex;flex-wrap:wrap;gap:8px}

    /* chips */
    .chip{border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);padding:6px 10px;border-radius:999px;font-size:12px}
    :root[data-theme="light"] .chip{border:1px solid rgba(148,163,184,.4);background:rgba(226,232,240,.6)}

    /* Bloc sites du tableau de bord */
    .sites-card{margin-bottom:16px}
    .site-panels{display:flex;gap:16px;flex-wrap:wrap;align-items:stretch}
    .site-panel{flex:1 1 320px;background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:18px;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:18px;min-width:280px}
    :root[data-theme="light"] .site-panel{border:1px solid rgba(15,23,42,.08)}
    .site-header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .site-title{font-size:16px;font-weight:700;letter-spacing:.4px;text-transform:uppercase}
    .site-badge{padding:4px 10px;border-radius:999px;background:rgba(167,139,250,.12);border:1px solid rgba(167,139,250,.28);font-size:12px}
    .site-section{display:flex;flex-direction:column;gap:12px}
    .site-section h4{margin:0;font-size:12px;color:var(--ink-dim);letter-spacing:.3px;text-transform:uppercase}
    .availability-summary{display:flex;align-items:center;gap:18px;flex-wrap:wrap}
    .availability-value{font-size:42px;font-weight:800;line-height:1}
    .availability-meta{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--ink-dim)}
    .trend-up{display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:rgba(16,185,129,.15);color:var(--ok);font-size:14px;font-weight:700}
    .legend-list{list-style:none;margin:0;padding:0;display:grid;gap:10px}
    .legend-list li{display:flex;align-items:center;justify-content:space-between;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:8px 12px;gap:12px}
    :root[data-theme="light"] .legend-list li{border:1px solid rgba(148,163,184,.18);background:rgba(148,163,184,.08)}
    .legend-item{display:flex;align-items:center;gap:10px;font-weight:600}
    .legend-count{font-variant-numeric:tabular-nums;font-weight:600}
    .dot{width:12px;height:12px;border-radius:50%;display:inline-block}
    .dot.ok{background:var(--ok)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}
    .dot.info{background:var(--brand)}
    .dot.attn{background:#facc15}

    @media (max-width:1100px){
      .app{grid-template-columns:1fr;grid-template-rows:auto 1fr}
      nav{order:2}
      main{order:3}
      header{order:1}
      .kpis{grid-template-columns:repeat(2,1fr)}
      .grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2l3 6 6 .75-4.5 4 1.2 6.25L12 16.5 6.3 19l1.2-6.25L3 8.75 9 8l3-6z" stroke="#0b1020" stroke-width="1.2" fill="white" opacity=".9"/>
          </svg>
        </div>
        <h1>GMAO STSI / GILLET</h1>
      </div>
      <div class="header-actions">
        <button class="btn" id="themeToggle" type="button" onclick="toggleTheme()" title="Basculer le thème" aria-pressed="false">🌙 Mode sombre</button>
        <button class="btn primary" onclick="openModal('diModal')">➕ Demande d’intervention</button>
      </div>
    </header>

    <nav>
      <div class="search" role="search">
        <span>🔎</span>
        <input id="globalSearch" placeholder="Rechercher… (machines, OT, pièces, fournisseurs)" oninput="globalFilter(this.value)">
      </div>
      <div class="menu" role="navigation">
        <a href="#" class="active" data-target="dashboard" onclick="switchSection(event)">📊 Tableau de bord</a>
        <a href="#" data-target="parc" onclick="switchSection(event)">🏭 Parc machines</a>
        <a href="#" data-target="interventions" onclick="switchSection(event)">🛠️ Interventions</a>
        <a href="#" data-target="preventif" onclick="switchSection(event)">⏱️ Préventif</a>
        <a href="#" data-target="contacts" onclick="switchSection(event)">📇 Contacts</a>
      </div>
    </nav>

    <main>
      <!-- Dashboard -->
      <section id="dashboard" class="section active" aria-label="Tableau de bord">
        <!-- Encart sites -->
        <div class="card sites-card">
          <h3>Sites suivis</h3>
          <div class="site-panels">
            <article class="site-panel">
              <div class="site-header">
                <span class="site-title">Site A</span>
                <span class="site-badge">Zone Nord</span>
              </div>
              <div class="site-section">
                <h4>Taux de Disponibilité</h4>
                <div class="availability-summary">
                  <span class="availability-value">50%</span>
                  <div class="availability-meta">
                    <span class="trend-up" aria-hidden="true">▲</span>
                    <span>2 machine(s) à l’arrêt</span>
                  </div>
                </div>
              </div>
              <div class="site-section">
                <h4>Répartition des Demandes d’intervention</h4>
                <ul class="legend-list" aria-label="Répartition des demandes">
                  <li>
                    <div class="legend-item"><span class="dot bad"></span><span>Attente</span></div>
                    <span class="legend-count">6</span>
                  </li>
                  <li>
                    <div class="legend-item"><span class="dot info"></span><span>En cours</span></div>
                    <span class="legend-count">9</span>
                  </li>
                  <li>
                    <div class="legend-item"><span class="dot ok"></span><span>Terminé</span></div>
                    <span class="legend-count">21</span>
                  </li>
                </ul>
              </div>
              <div class="site-section">
                <h4>État des Équipements</h4>
                <ul class="legend-list" aria-label="État des équipements">
                  <li>
                    <div class="legend-item"><span class="dot ok"></span><span>Opérationnelles</span></div>
                    <span class="legend-count">32</span>
                  </li>
                  <li>
                    <div class="legend-item"><span class="dot warn"></span><span>En maintenance</span></div>
                    <span class="legend-count">5</span>
                  </li>
                  <li>
                    <div class="legend-item"><span class="dot bad"></span><span>À l’arrêt</span></div>
                    <span class="legend-count">2</span>
                  </li>
                  <li>
                    <div class="legend-item"><span class="dot attn"></span><span>Préventifs à réaliser</span></div>
                    <span class="legend-count">7</span>
                  </li>
                </ul>
              </div>
            </article>
            <article class="site-panel">
              <div class="site-header">
                <span class="site-title">Site B</span>
                <span class="site-badge">Zone Sud</span>
              </div>
              <div class="site-section">
                <h4>Taux de Disponibilité</h4>
                <div class="availability-summary">
                  <span class="availability-value">78%</span>
                  <div class="availability-meta">
                    <span class="trend-up" aria-hidden="true">▲</span>
                    <span>1 machine(s) à l’arrêt</span>
                  </div>
                </div>
              </div>
              <div class="site-section">
                <h4>Répartition des Demandes d’intervention</h4>
                <ul class="legend-list" aria-label="Répartition des demandes">
                  <li>
                    <div class="legend-item"><span class="dot bad"></span><span>Attente</span></div>
                    <span class="legend-count">3</span>
                  </li>
                  <li>
                    <div class="legend-item"><span class="dot info"></span><span>En cours</span></div>
                    <span class="legend-count">4</span>
                  </li>
                  <li>
                    <div class="legend-item"><span class="dot ok"></span><span>Terminé</span></div>
                    <span class="legend-count">15</span>
                  </li>
                </ul>
              </div>
              <div class="site-section">
                <h4>État des Équipements</h4>
                <ul class="legend-list" aria-label="État des équipements">
                  <li>
                    <div class="legend-item"><span class="dot ok"></span><span>Opérationnelles</span></div>
                    <span class="legend-count">18</span>
                  </li>
                  <li>
                    <div class="legend-item"><span class="dot warn"></span><span>En maintenance</span></div>
                    <span class="legend-count">3</span>
                  </li>
                  <li>
                    <div class="legend-item"><span class="dot bad"></span><span>À l’arrêt</span></div>
                    <span class="legend-count">1</span>
                  </li>
                  <li>
                    <div class="legend-item"><span class="dot attn"></span><span>Préventifs à réaliser</span></div>
                    <span class="legend-count">2</span>
                  </li>
                </ul>
              </div>
            </article>
          </div>
        </div>

        <div class="kpis">
          <div class="card"><h3>OT Ouverts</h3><div class="value">18</div><span class="tag warn">+3 cette semaine</span></div>
          <div class="card"><h3>Taux préventif réalisé</h3><div class="value">86%</div><span class="tag ok">Objectif ≥ 80%</span></div>
        </div>

        <div class="card backlog-card">
          <h3>Backlog par priorité</h3>
          <div class="toolbar">
            <span class="chip">P1: 4</span>
            <span class="chip">P2: 9</span>
            <span class="chip">P3: 5</span>
            <button class="btn" onclick="openModal('reportModal')">📈 Export rapide</button>
          </div>
          <div class="table-wrapper">
            <table aria-label="Backlog OT">
              <thead><tr><th>OT</th><th>Machine</th><th>Type</th><th>Priorité</th><th>Statut</th><th>Prévu</th></tr></thead>
              <tbody id="tblBacklog">
                <tr><td>OT-1024</td><td>DMU 70</td><td>Correctif</td><td>P1</td><td><span class="status warn">En cours</span></td><td>24/09/2025</td></tr>
                <tr><td>OT-1025</td><td>Tornos Deco</td><td>Qualité</td><td>P2</td><td><span class="status ok">Planifié</span></td><td>26/09/2025</td></tr>
                <tr><td>OT-1026</td><td>Compresseur KAESER</td><td>Sécurité</td><td>P1</td><td><span class="status bad">En retard</span></td><td>22/09/2025</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Parc -->
      <section id="parc" class="section" aria-label="Parc machines">
        <div class="toolbar">
          <input class="input" placeholder="Filtrer par zone…" oninput="filterTable('tblParc', this.value, [0])">
          <select onchange="filterTable('tblParc', this.value, [2])">
            <option value="">Tous fabricants</option>
            <option>DMG Mori</option>
            <option>Tornos</option>
            <option>Kaeser</option>
          </select>
          <button class="btn" onclick="openModal('equipModal')">➕ Ajouter équipement</button>
        </div>
        <table aria-label="Parc">
          <thead><tr><th>Zone</th><th>Machine</th><th>Fabricant</th><th>Modèle</th><th>Numéro série</th><th>Année</th></tr></thead>
          <tbody id="tblParc">
            <tr><td>Fraisage</td><td>Centre d'usinage 5 axes</td><td>DMG Mori</td><td>DMU 70</td><td>FR-DMU70-2021</td><td>2021</td></tr>
            <tr><td>Tournage</td><td>Tour CN polyvalent</td><td>Tornos</td><td>Deco 2000</td><td>TN-DEC-2018</td><td>2018</td></tr>
            <tr><td>Utilities</td><td>Compresseur d'air</td><td>Kaeser</td><td>SX 6</td><td>KS-SX6-2016</td><td>2016</td></tr>
          </tbody>
        </table>
      </section>

      <!-- Interventions -->
      <section id="interventions" class="section" aria-label="Interventions">
        <div class="toolbar">
          <select id="selType" class="input" onchange="filterTable('tblOT', this.value, [2])">
            <option value="">Type: Tous</option>
            <option>Correctif</option>
            <option>Palliatif</option>
            <option>Qualité</option>
            <option>Sécurité</option>
          </select>
          <select id="selPrio" class="input" onchange="filterTable('tblOT', this.value, [3])">
            <option value="">Priorité: Toutes</option>
            <option>P1</option>
            <option>P2</option>
            <option>P3</option>
          </select>
          <input class="input" placeholder="Rechercher travaux…" oninput="filterTable('tblOT', this.value, [5])">
          <button class="btn" onclick="openModal('otModal')">➕ Nouvel OT</button>
        </div>
        <table aria-label="Interventions">
          <thead><tr><th>OT</th><th>Machine</th><th>Type</th><th>Priorité</th><th>Statut</th><th>Travaux</th><th>Prévu</th></tr></thead>
          <tbody id="tblOT">
            <tr class="clickable" role="button" tabindex="0" aria-label="Ouvrir l'intervention OT-1024"
                data-ot="OT-1024"
                data-machine="DMU 70"
                data-type="Correctif"
                data-priorite="P1"
                data-statut="En cours"
                data-status="En cours"
                data-travaux="Vibrations broche"
                data-intervenant="N. Dupont"
                data-description="Remplacement des roulements de broche et réalignement."
                data-temps-intervention="3.5"
                data-temps-arret="2"
                data-resolution="2025-09-24"
                data-type-intervention="curatif">
              <td>OT-1024</td>
              <td>DMU 70</td>
              <td>Correctif</td>
              <td>P1</td>
              <td><span class="status warn">En cours</span></td>
              <td>Vibrations broche</td>
              <td>24/09/2025</td>
            </tr>
            <tr class="clickable" role="button" tabindex="0" aria-label="Ouvrir l'intervention OT-1025"
                data-ot="OT-1025"
                data-machine="Tornos Deco"
                data-type="Qualité"
                data-priorite="P2"
                data-statut="Planifié"
                data-status="Planifié"
                data-travaux="Contrôle géométrie"
                data-intervenant=""
                data-description=""
                data-temps-intervention=""
                data-temps-arret="0"
                data-resolution=""
                data-type-intervention="preventif">
              <td>OT-1025</td>
              <td>Tornos Deco</td>
              <td>Qualité</td>
              <td>P2</td>
              <td><span class="status ok">Planifié</span></td>
              <td>Contrôle géométrie</td>
              <td>26/09/2025</td>
            </tr>
            <tr class="clickable" role="button" tabindex="0" aria-label="Ouvrir l'intervention OT-1026"
                data-ot="OT-1026"
                data-machine="Compresseur KAESER"
                data-type="Sécurité"
                data-priorite="P1"
                data-statut="En retard"
                data-status="En retard"
                data-travaux="Remplacer cartouche"
                data-intervenant="Equipe maintenance"
                data-description="Attente de la pièce de rechange, intervention planifiée."
                data-temps-intervention="1.5"
                data-temps-arret="1.5"
                data-resolution="2025-09-22"
                data-type-intervention="correctif">
              <td>OT-1026</td>
              <td>Compresseur KAESER</td>
              <td>Sécurité</td>
              <td>P1</td>
              <td><span class="status bad">En retard</span></td>
              <td>Remplacer cartouche</td>
              <td>22/09/2025</td>
            </tr>
          </tbody>
        </table>
      </section>

      <!-- Préventif -->
      <section id="preventif" class="section" aria-label="Préventif">
        <div class="toolbar">
          <select class="input" onchange="filterTable('tblPrev', this.value, [2])">
            <option value="">Périodicité</option>
            <option>Hebdo</option>
            <option>Mensuel</option>
            <option>Trimestriel</option>
          </select>
          <button class="btn" onclick="openModal('planModal')">⚙️ Générer OT préventifs</button>
        </div>
        <table aria-label="Plan préventif">
          <thead><tr><th>Plan</th><th>Machine</th><th>Périodicité</th><th>Dernier</th><th>Prochain</th><th>État</th></tr></thead>
        <tbody id="tblPrev">
          <tr><td>PV-001</td><td>DMU 70</td><td>Mensuel</td><td>28/08/2025</td><td>28/09/2025</td><td><span class="status ok">À l'heure</span></td></tr>
          <tr><td>PV-017</td><td>Tornos Deco</td><td>Hebdo</td><td>18/09/2025</td><td>25/09/2025</td><td><span class="status warn">À lancer</span></td></tr>
          <tr><td>PV-023</td><td>Compresseur KAESER</td><td>Trimestriel</td><td>10/07/2025</td><td>10/10/2025</td><td><span class="status ok">OK</span></td></tr>
        </tbody>
        </table>
      </section>

      <!-- Contacts -->
      <section id="contacts" class="section" aria-label="Contacts">
        <div class="toolbar">
          <input class="input" placeholder="Rechercher fournisseur/intervenant…" oninput="filterTable('tblContacts', this.value, [0,1,2,3])">
          <button class="btn" onclick="openModal('contactModal')">➕ Nouveau contact</button>
        </div>
        <table aria-label="Contacts">
          <thead><tr><th>Entreprise</th><th>Activité</th><th>Contact</th><th>Email</th><th>Téléphone</th></tr></thead>
          <tbody id="tblContacts">
            <tr><td>AirTech</td><td>Compresseurs</td><td>J. Martin</td><td>service@airtech.tld</td><td>+33 4 12 34 56 78</td></tr>
            <tr><td>MecaPro</td><td>Fourniture Mécanique</td><td>S. Leroy</td><td>contact@mecapro.tld</td><td>+33 1 98 76 54 32</td></tr>
          </tbody>
        </table>
      </section>

    </main>
  </div>

  <!-- Modals -->
  <div class="modal" id="otModal" role="dialog" aria-modal="true" aria-hidden="true" aria-label="Créer un OT">
    <div class="sheet">
      <header>
        <div class="brand"><div class="logo" style="width:28px;height:28px"></div><h1>Nouvel ordre de travail</h1></div>
      </header>
      <div class="content">
        <div class="grid">
          <div class="field"><label>Machine</label><input placeholder="ex. DMU 70"/></div>
          <div class="field"><label>Type</label><select><option>Correctif</option><option>Palliatif</option><option>Qualité</option><option>Sécurité</option></select></div>
          <div class="field"><label>Priorité</label><select><option>P1</option><option>P2</option><option>P3</option></select></div>
          <div class="field"><label>Prévu le</label><input type="date"/></div>
          <div class="field" style="grid-column:1/-1"><label>Travaux à effectuer</label><textarea rows="3" placeholder="Décrire la demande…"></textarea></div>
        </div>
      </div>
      <div class="actions">
        <button class="btn" onclick="closeModal('otModal')">Annuler</button>
        <button class="btn primary" onclick="closeModal('otModal')">Créer</button>
      </div>
    </div>
  </div>

  <div class="modal" id="diModal" role="dialog" aria-modal="true" aria-hidden="true" aria-label="Créer une demande d’intervention">
    <div class="sheet">
      <header>
        <div class="brand">
          <div class="logo" style="width:28px;height:28px"></div>
          <h1>Nouvelle demande d’intervention</h1>
        </div>
      </header>
      <div class="content">
        <div class="grid">
          <div class="field">
            <label>Date de la demande</label>
            <input type="date"/>
          </div>
          <div class="field">
            <label>Machine</label>
            <input type="text" placeholder="Nom de la machine…"/>
          </div>
          <div class="field">
            <label>Type</label>
            <select>
              <option value="correctif">Correctif</option>
              <option value="palliatif">Palliatif</option>
              <option value="qualite">Qualité</option>
              <option value="securite">Sécurité</option>
            </select>
          </div>
          <div class="field">
            <label>Priorité</label>
            <select>
              <option value="P1">P1 — Urgent (machine à l’arrêt)</option>
              <option value="P2">P2 — Moyen (défaut sans interruption)</option>
              <option value="P3">P3 — Faible</option>
            </select>
          </div>
          <div class="field">
            <label>Machine à l’arrêt</label>
            <select>
              <option value="oui">Oui</option>
              <option value="non">Non</option>
            </select>
          </div>
          <div class="field" style="grid-column:1/-1">
            <label>Travaux à effectuer</label>
            <textarea rows="3" placeholder="Décrire les travaux demandés…"></textarea>
          </div>
          <div class="field attachments" style="grid-column:1/-1">
            <label>Pièces jointes</label>
            <div class="attachment-actions">
              <input id="diAttachmentInput" type="file" accept="image/*,.pdf,.doc,.docx,.txt,.xlsx,.xls,.ppt,.pptx" multiple hidden>
              <button type="button" class="btn" id="diUploadButton">📎 Ajouter un fichier</button>
              <button type="button" class="btn" id="diCameraButton" aria-expanded="false">📷 Prendre une photo</button>
            </div>
            <ul id="diAttachmentList" class="attachment-list"></ul>
            <div class="camera-preview" id="diCameraPreview" hidden>
              <video id="diCameraVideo" autoplay playsinline></video>
              <div class="camera-actions">
                <button type="button" class="btn primary" id="diCaptureBtn">📸 Capturer</button>
                <button type="button" class="btn" id="diCloseCameraBtn">✖️ Fermer la caméra</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="actions">
        <button class="btn" onclick="closeModal('diModal')">Annuler</button>
        <button class="btn primary" onclick="closeModal('diModal')">Envoyer</button>
      </div>
    </div>
  </div>

  <div class="modal" id="interventionModal" role="dialog" aria-modal="true" aria-hidden="true" aria-label="Compte-rendu d'intervention">
    <div class="sheet">
      <header>
        <div class="brand">
          <div class="logo" style="width:28px;height:28px"></div>
          <h1>Compte-rendu d'intervention</h1>
        </div>
      </header>
      <div class="content">
        <div class="grid">
          <div class="field">
            <label for="interventionOt">OT</label>
            <input id="interventionOt" type="text" readonly>
          </div>
          <div class="field">
            <label for="interventionMachine">Machine</label>
            <input id="interventionMachine" type="text" readonly>
          </div>
          <div class="field">
            <label for="interventionStatut">Statut</label>
            <input id="interventionStatut" type="text" readonly>
          </div>
          <div class="field">
            <label for="interventionPriorite">Priorité</label>
            <select id="interventionPriorite">
              <option value="P1">P1</option>
              <option value="P2">P2</option>
              <option value="P3">P3</option>
            </select>
          </div>
          <div class="field">
            <label for="interventionIntervenant">Intervenant</label>
            <input id="interventionIntervenant" type="text" placeholder="Nom de l'intervenant">
          </div>
          <div class="field">
            <label for="interventionType">Type d’intervention</label>
            <select id="interventionType">
              <option value="correctif">Correctif</option>
              <option value="curatif">Curatif</option>
              <option value="preventif">Préventif</option>
              <option value="amelioration">Amélioration</option>
              <option value="securite">Sécurité</option>
            </select>
          </div>
          <div class="field" style="grid-column:1/-1">
            <label for="interventionDescription">Intervention réalisée</label>
            <textarea id="interventionDescription" rows="4" placeholder="Décrire les actions menées…"></textarea>
          </div>
          <div class="field">
            <label for="interventionDuree">Temps d’intervention (h)</label>
            <input id="interventionDuree" type="number" min="0" step="0.25" placeholder="0">
          </div>
          <div class="field">
            <label for="interventionArret">Temps d’arrêt machine (h)</label>
            <input id="interventionArret" type="number" min="0" step="0.25" placeholder="0">
          </div>
          <div class="field">
            <label for="interventionResolution">Date de résolution</label>
            <input id="interventionResolution" type="date">
          </div>
        </div>
      </div>
      <div class="actions">
        <button class="btn" type="button" onclick="closeModal('interventionModal')">Fermer</button>
        <button class="btn primary" type="button" onclick="saveInterventionDetails()">Enregistrer</button>
      </div>
    </div>
  </div>

  <div class="modal" id="equipModal" role="dialog" aria-modal="true" aria-hidden="true" aria-label="Ajouter un équipement"><div class="sheet"><header><div class="brand"><div class="logo" style="width:28px;height:28px"></div><h1>Ajouter équipement</h1></div></header><div class="content"><div class="grid"><div class="field"><label for="equip-zone">Zone</label><input id="equip-zone" type="text" placeholder="Zone de l'équipement"></div><div class="field"><label for="equip-machine">Machine</label><input id="equip-machine" type="text" placeholder="Nom de la machine"></div><div class="field"><label for="equip-fabricant">Fabricant</label><input id="equip-fabricant" type="text" placeholder="Fabricant"></div><div class="field"><label for="equip-modele">Modèle</label><input id="equip-modele" type="text" placeholder="Référence ou modèle"></div><div class="field"><label for="equip-serial">Numéro de série</label><input id="equip-serial" type="text" placeholder="Numéro de série"></div><div class="field"><label for="equip-annee">Année</label><input id="equip-annee" type="number" inputmode="numeric" min="1900" max="2100" placeholder="Année de mise en service"></div></div></div><div class="actions"><button class="btn" onclick="closeModal('equipModal')">Fermer</button><button class="btn primary" onclick="closeModal('equipModal')">Enregistrer</button></div></div></div>
  <div class="modal" id="contactModal" role="dialog" aria-modal="true" aria-hidden="true" aria-label="Créer un contact"><div class="sheet"><header><div class="brand"><div class="logo" style="width:28px;height:28px"></div><h1>Nouveau contact</h1></div></header><div class="content"><div class="grid"><div class="field"><label>Entreprise</label><input></div><div class="field"><label>Activité</label><input></div><div class="field"><label>Contact</label><input></div><div class="field"><label>Email</label><input type="email"></div><div class="field"><label>Téléphone</label><input></div></div></div><div class="actions"><button class="btn" onclick="closeModal('contactModal')">Fermer</button><button class="btn primary" onclick="closeModal('contactModal')">Enregistrer</button></div></div></div>
  <div class="modal" id="planModal" role="dialog" aria-modal="true" aria-hidden="true" aria-label="Générer des OT préventifs"><div class="sheet"><header><div class="brand"><div class="logo" style="width:28px;height:28px"></div><h1>Générer OT préventifs</h1></div></header><div class="content"><p>Sélectionner l'horizon de planification et la périodicité.</p><div class="grid"><div class="field"><label>Horizon (jours)</label><input type="number" value="30"></div><div class="field"><label>Inclure retard</label><select><option>Oui</option><option>Non</option></select></div></div></div><div class="actions"><button class="btn" onclick="closeModal('planModal')">Fermer</button><button class="btn primary" onclick="closeModal('planModal')">Générer</button></div></div></div>
  <div class="modal" id="reportModal" role="dialog" aria-modal="true" aria-hidden="true" aria-label="Exporter les données"><div class="sheet"><header><div class="brand"><div class="logo" style="width:28px;height:28px"></div><h1>Export rapide</h1></div></header><div class="content"><p>Ce prototype exportera un CSV fictif. À connecter à votre backend plus tard.</p></div><div class="actions"><button class="btn" onclick="closeModal('reportModal')">Fermer</button><button class="btn primary" onclick="fakeExport()">Exporter CSV</button></div></div></div>

  <script>
    const THEMES = {
      dark:{
        '--bg':'#0f172a',
        '--panel':'#111827',
        '--muted':'#1f2937',
        '--card':'#0b1220',
        '--ink':'#e5e7eb',
        '--ink-dim':'#9ca3af',
        '--brand':'#22d3ee',
        '--accent':'#a78bfa',
        '--ok':'#10b981',
        '--warn':'#f59e0b',
        '--bad':'#ef4444',
        '--shadow':'0 10px 25px rgba(0,0,0,.25), 0 1px 0 rgba(255,255,255,.03) inset'
      },
      light:{
        '--bg':'#f1f5f9',
        '--panel':'#ffffff',
        '--muted':'#e2e8f0',
        '--card':'#f8fafc',
        '--ink':'#0f172a',
        '--ink-dim':'#475569',
        '--brand':'#0ea5e9',
        '--accent':'#6366f1',
        '--ok':'#059669',
        '--warn':'#d97706',
        '--bad':'#dc2626',
        '--shadow':'0 12px 28px rgba(15,23,42,.12), 0 1px 0 rgba(15,23,42,.04) inset'
      }
    };
    const FOCUSABLE_SELECTOR = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
    const INTERVENTION_TYPE_LABELS = {
      correctif:'Correctif',
      curatif:'Curatif',
      preventif:'Préventif',
      amelioration:'Amélioration',
      securite:'Sécurité'
    };
    let currentTheme = 'dark';
    let activeModal = null;
    let lastFocusedElement = null;
    let currentInterventionRow = null;
    let diAttachments = [];
    let diCameraStream = null;

    function switchSection(e){
      e.preventDefault();
      const target = e.currentTarget.getAttribute('data-target');
      document.querySelectorAll('.menu a').forEach(a=>a.classList.toggle('active', a.getAttribute('data-target')===target));
      document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
      document.getElementById(target).classList.add('active');
    }

    function applyTheme(theme,{persist=true}={}){
      if(!THEMES[theme]) theme='dark';
      currentTheme = theme;
      const root = document.documentElement;
      root.dataset.theme = theme;
      const vars = THEMES[theme];
      Object.entries(vars).forEach(([key,val])=>root.style.setProperty(key,val));
      if(persist){
        try{ localStorage.setItem('gmao-theme', theme); }catch(_e){/* storage non critique */}
      }
      updateThemeToggle();
    }

    function updateThemeToggle(){
      const btn = document.getElementById('themeToggle');
      if(!btn) return;
      const isLight = currentTheme === 'light';
      btn.setAttribute('aria-pressed', isLight ? 'true' : 'false');
      btn.textContent = isLight ? '🌞 Mode clair' : '🌙 Mode sombre';
    }

    function toggleTheme(){
      const next = currentTheme === 'dark' ? 'light' : 'dark';
      applyTheme(next);
    }

    function openModal(id){
      const modal = document.getElementById(id);
      if(!modal) return;
      lastFocusedElement = document.activeElement instanceof HTMLElement ? document.activeElement : null;
      modal.classList.add('open');
      modal.setAttribute('aria-hidden','false');
      activeModal = modal;
      document.body.style.overflow = 'hidden';
      const focusable = modal.querySelectorAll(FOCUSABLE_SELECTOR);
      if(focusable.length){
        focusable[0].focus({preventScroll:true});
      }
    }

    function closeModal(id){
      const modal = document.getElementById(id);
      if(!modal) return;
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden','true');
      if(id === 'interventionModal'){
        currentInterventionRow = null;
      }else if(id === 'diModal'){
        resetDemandModal();
      }
      if(activeModal === modal) activeModal = null;
      if(!document.querySelector('.modal.open')){
        document.body.style.overflow = '';
        if(lastFocusedElement && document.body.contains(lastFocusedElement)){
          lastFocusedElement.focus({preventScroll:true});
        }
        lastFocusedElement = null;
      }
    }

    function closeActiveModal(){
      if(activeModal){
        closeModal(activeModal.id);
      }
    }

    function addAttachments(files){
      if(!files || !files.length) return;
      diAttachments = diAttachments.concat(files);
      renderAttachments();
    }

    function renderAttachments(){
      const list = document.getElementById('diAttachmentList');
      if(!list) return;
      list.innerHTML = '';
      if(!diAttachments.length){
        const empty = document.createElement('li');
        empty.className = 'attachment-empty';
        empty.textContent = 'Aucune pièce jointe pour le moment.';
        list.appendChild(empty);
        return;
      }
      diAttachments.forEach((file,index)=>{
        const li = document.createElement('li');
        li.className = 'attachment-item';
        const info = document.createElement('div');
        info.className = 'attachment-info';
        const name = document.createElement('span');
        name.className = 'attachment-name';
        name.textContent = file.name || `Photo ${index+1}.jpg`;
        info.appendChild(name);
        if(file.size){
          const meta = document.createElement('span');
          meta.className = 'attachment-meta';
          const sizeKB = Math.max(1, Math.round(file.size/1024));
          meta.textContent = `${sizeKB} Ko`;
          info.appendChild(meta);
        }
        const remove = document.createElement('button');
        remove.type = 'button';
        remove.className = 'attachment-remove';
        remove.setAttribute('data-remove-index', index);
        remove.setAttribute('aria-label', `Retirer ${name.textContent}`);
        remove.textContent = '✖️';
        li.appendChild(info);
        li.appendChild(remove);
        list.appendChild(li);
      });
    }

    function removeAttachment(index){
      if(index<0 || index>=diAttachments.length) return;
      diAttachments.splice(index,1);
      renderAttachments();
    }

    async function openCamera(){
      const preview = document.getElementById('diCameraPreview');
      const video = document.getElementById('diCameraVideo');
      const toggleBtn = document.getElementById('diCameraButton');
      if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
        alert('La capture depuis la caméra n’est pas supportée sur cet appareil.');
        return;
      }
      try{
        diCameraStream = await navigator.mediaDevices.getUserMedia({video:true});
        if(video){
          video.srcObject = diCameraStream;
        }
        if(preview){
          preview.hidden = false;
        }
        if(toggleBtn){
          toggleBtn.setAttribute('aria-expanded','true');
          toggleBtn.textContent = '📷 Fermer la caméra';
        }
      }catch(err){
        console.error('Impossible d’ouvrir la caméra', err);
        alert('Impossible d’accéder à la caméra. Vérifiez les autorisations.');
      }
    }

    function closeCamera(){
      const preview = document.getElementById('diCameraPreview');
      const video = document.getElementById('diCameraVideo');
      const toggleBtn = document.getElementById('diCameraButton');
      if(diCameraStream){
        diCameraStream.getTracks().forEach(track=>track.stop());
        diCameraStream = null;
      }
      if(video){
        video.srcObject = null;
      }
      if(preview){
        preview.hidden = true;
      }
      if(toggleBtn){
        toggleBtn.setAttribute('aria-expanded','false');
        toggleBtn.textContent = '📷 Prendre une photo';
      }
    }

    function capturePhoto(){
      const video = document.getElementById('diCameraVideo');
      if(!video || !diCameraStream || video.readyState < 2){
        return;
      }
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      if(!ctx){
        return;
      }
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      canvas.toBlob(blob=>{
        if(!blob) return;
        const timestamp = new Date().toISOString().replace(/[:.]/g,'-');
        let file;
        try{
          file = new File([blob], `photo-${timestamp}.jpg`, {type:'image/jpeg'});
        }catch(_e){
          file = blob;
          file.name = `photo-${timestamp}.jpg`;
        }
        addAttachments([file]);
      }, 'image/jpeg', 0.92);
    }

    function resetDemandModal(){
      diAttachments = [];
      const input = document.getElementById('diAttachmentInput');
      if(input){
        input.value = '';
      }
      renderAttachments();
      closeCamera();
    }

    // Simple global filter across visible table bodies
    function globalFilter(q){
      q = (q||'').toLowerCase();
      document.querySelectorAll('tbody').forEach(tb=>{
        tb.querySelectorAll('tr').forEach(tr=>{
          const hit = tr.innerText.toLowerCase().includes(q);
          tr.style.display = hit ? '' : 'none';
        });
      });
    }

    function filterTable(tbodyId, q, cols){
      q = (q||'').toLowerCase();
      const rows = document.getElementById(tbodyId).rows;
      for(const tr of rows){
        if(!q){ tr.style.display=''; continue; }
        let hit=false;
        (cols||[...tr.cells].map((_,i)=>i)).forEach(i=>{
          const cell = tr.cells[i];
          if(cell && cell.innerText.toLowerCase().includes(q)) hit=true;
        });
        tr.style.display = hit?'':'none';
      }
    }

    function filterStatus(tbodyId, status){
      const rows = document.getElementById(tbodyId).rows;
      for(const tr of rows){
        const st = (tr.getAttribute('data-status')||'').toLowerCase();
        tr.style.display = !status || st===status ? '' : 'none';
      }
    }

    function setupInterventionRows(){
      document.querySelectorAll('#tblOT tr').forEach(tr=>{
        tr.addEventListener('click', ()=>openInterventionDetail(tr));
        tr.addEventListener('keydown', evt=>{
          if(evt.key==='Enter' || evt.key===' '){
            evt.preventDefault();
            openInterventionDetail(tr);
          }
        });
      });
    }

    function openInterventionDetail(row){
      currentInterventionRow = row;
      const ds = row.dataset;
      const fields = {
        ot:document.getElementById('interventionOt'),
        machine:document.getElementById('interventionMachine'),
        statut:document.getElementById('interventionStatut'),
        priorite:document.getElementById('interventionPriorite'),
        intervenant:document.getElementById('interventionIntervenant'),
        type:document.getElementById('interventionType'),
        description:document.getElementById('interventionDescription'),
        duree:document.getElementById('interventionDuree'),
        arret:document.getElementById('interventionArret'),
        resolution:document.getElementById('interventionResolution')
      };

      if(!fields.ot) return;

      fields.ot.value = ds.ot || '';
      fields.machine.value = ds.machine || '';
      fields.statut.value = ds.statut || '';
      fields.priorite.value = ds.priorite || 'P1';
      fields.intervenant.value = ds.intervenant || '';
      fields.type.value = ds.typeIntervention || 'correctif';
      fields.description.value = ds.description || '';
      fields.duree.value = ds.tempsIntervention || '';
      fields.arret.value = ds.tempsArret || '';
      fields.resolution.value = ds.resolution || '';

      openModal('interventionModal');
      if(fields.intervenant){
        requestAnimationFrame(()=>{
          fields.intervenant.focus({preventScroll:true});
        });
      }
    }

    function saveInterventionDetails(){
      if(!currentInterventionRow){
        closeModal('interventionModal');
        return;
      }
      const ds = currentInterventionRow.dataset;
      const priorite = document.getElementById('interventionPriorite').value;
      const intervenant = document.getElementById('interventionIntervenant').value.trim();
      const type = document.getElementById('interventionType').value;
      const description = document.getElementById('interventionDescription').value.trim();
      const duree = document.getElementById('interventionDuree').value;
      const arret = document.getElementById('interventionArret').value;
      const resolution = document.getElementById('interventionResolution').value;
      const typeLabel = INTERVENTION_TYPE_LABELS[type] || type;

      ds.priorite = priorite;
      ds.type = typeLabel;
      ds.intervenant = intervenant;
      ds.typeIntervention = type;
      ds.description = description;
      ds.tempsIntervention = duree;
      ds.tempsArret = arret;
      ds.resolution = resolution;

      currentInterventionRow.cells[2].innerText = typeLabel;
      currentInterventionRow.cells[3].innerText = priorite;

      closeModal('interventionModal');
    }

    function fakeExport(){
      const rows = [['OT','Machine','Priorité','Statut','Prévu'], ...Array.from(document.querySelectorAll('#tblOT tr')).map(tr=>[...tr.cells].slice(0,5).map(td=>td.innerText.trim()))];
      const csv = rows.map(r=>r.join(';')).join('\n');
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'export_ot.csv'; a.click();
      URL.revokeObjectURL(url);
    }

    function init(){
      let savedTheme = null;
      try{ savedTheme = localStorage.getItem('gmao-theme'); }catch(_e){ savedTheme = null; }
      applyTheme(savedTheme || 'dark', {persist:false});

      document.querySelectorAll('.modal').forEach(modal=>{
        modal.addEventListener('click', evt=>{
          if(evt.target === modal) closeModal(modal.id);
        });
      });

      setupInterventionRows();

      const attachmentInput = document.getElementById('diAttachmentInput');
      const uploadButton = document.getElementById('diUploadButton');
      const attachmentList = document.getElementById('diAttachmentList');
      const cameraButton = document.getElementById('diCameraButton');
      const captureButton = document.getElementById('diCaptureBtn');
      const closeCameraBtn = document.getElementById('diCloseCameraBtn');

      if(uploadButton && attachmentInput){
        uploadButton.addEventListener('click', ()=>attachmentInput.click());
      }

      if(attachmentInput){
        attachmentInput.addEventListener('change', evt=>{
          const files = Array.from(evt.target.files || []);
          addAttachments(files);
          attachmentInput.value = '';
        });
      }

      if(attachmentList){
        attachmentList.addEventListener('click', evt=>{
          const btn = evt.target.closest('button[data-remove-index]');
          if(btn){
            evt.preventDefault();
            const index = Number(btn.getAttribute('data-remove-index'));
            removeAttachment(index);
          }
        });
      }

      if(cameraButton){
        cameraButton.addEventListener('click', evt=>{
          evt.preventDefault();
          if(diCameraStream){
            closeCamera();
          }else{
            openCamera();
          }
        });
      }

      if(captureButton){
        captureButton.addEventListener('click', evt=>{
          evt.preventDefault();
          capturePhoto();
        });
      }

      if(closeCameraBtn){
        closeCameraBtn.addEventListener('click', evt=>{
          evt.preventDefault();
          closeCamera();
        });
      }

      renderAttachments();

      document.addEventListener('keydown', evt=>{
        if(evt.key === 'Escape' && activeModal){
          evt.preventDefault();
          closeActiveModal();
        }else if(evt.key === 'Tab' && activeModal){
          const focusable = Array.from(activeModal.querySelectorAll(FOCUSABLE_SELECTOR)).filter(el=>!el.hasAttribute('disabled') && !el.getAttribute('aria-hidden'));
          if(!focusable.length) return;
          const first = focusable[0];
          const last = focusable[focusable.length-1];
          const active = document.activeElement;
          if(evt.shiftKey && active === first){
            evt.preventDefault();
            last.focus();
          }else if(!evt.shiftKey && active === last){
            evt.preventDefault();
            first.focus();
          }
        }
      });

    }

    if(document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', init);
    }else{
      init();
    }
  </script>
</body>
</html>

