<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <title>Prototype GMAO – Modèle HTML</title>
  <style>
    :root{
      --bg:#0f172a;          /* slate-900 */
      --panel:#111827;       /* gray-900 */
      --muted:#1f2937;       /* gray-800 */
      --card:#0b1220;        /* dark card */
      --ink:#e5e7eb;         /* gray-200 */
      --ink-dim:#9ca3af;     /* gray-400 */
      --brand:#22d3ee;       /* cyan-400 */
      --accent:#a78bfa;      /* violet-400 */
      --ok:#10b981;          /* emerald */
      --warn:#f59e0b;        /* amber */
      --bad:#ef4444;         /* red */
      --shadow:0 10px 25px rgba(0,0,0,.25), 0 1px 0 rgba(255,255,255,.03) inset;
      --radius:16px;
    }
    :root[data-theme="light"]{
      --bg:#f1f5f9;
      --panel:#ffffff;
      --muted:#e2e8f0;
      --card:#f8fafc;
      --ink:#0f172a;
      --ink-dim:#475569;
      --brand:#0ea5e9;
      --accent:#6366f1;
      --ok:#059669;
      --warn:#d97706;
      --bad:#dc2626;
      --shadow:0 12px 28px rgba(15,23,42,.12), 0 1px 0 rgba(15,23,42,.04) inset;
    }
    *{box-sizing:border-box}
    [hidden]{display:none!important}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 600px at 80% -10%,rgba(167,139,250,.15),transparent),
                          radial-gradient(900px 500px at -20% 10%,rgba(34,211,238,.12),transparent),
                          var(--bg);color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,"Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji";}
    :root[data-theme="light"] body{background:radial-gradient(1200px 600px at 80% -10%,rgba(99,102,241,.14),transparent),
                                   radial-gradient(900px 500px at -20% 10%,rgba(14,165,233,.12),transparent),
                                   var(--bg);}
    a{color:inherit;text-decoration:none}
    a:focus-visible,button:focus-visible,input:focus-visible,select:focus-visible,textarea:focus-visible{
      outline:2px solid var(--accent);
      outline-offset:2px;
    }
    .app{display:grid;grid-template-columns:minmax(200px,260px) 1fr;grid-template-rows:64px 1fr;height:100vh;gap:16px;padding:16px}
    header{grid-column:1/-1;height:64px;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.06);backdrop-filter:blur(6px);border-radius:var(--radius);display:flex;align-items:center;justify-content:space-between;padding:0 16px;box-shadow:var(--shadow)}
    :root[data-theme="light"] header,
    :root[data-theme="light"] nav,
    :root[data-theme="light"] main{background:linear-gradient(180deg,rgba(15,23,42,.05),rgba(15,23,42,.02));border:1px solid rgba(15,23,42,.08);}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:36px;height:36px;border-radius:12px;background:linear-gradient(135deg,var(--brand),var(--accent));display:grid;place-items:center;box-shadow:0 6px 20px rgba(34,211,238,.3)}
    .logo svg{filter:drop-shadow(0 2px 6px rgba(0,0,0,.3))}
    .brand h1{font-size:16px;letter-spacing:.3px;margin:0;font-weight:700}
    .header-actions{display:flex;gap:8px;align-items:center}
    .btn{background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);padding:8px 12px;border-radius:12px;color:var(--ink);display:inline-flex;gap:8px;align-items:center;cursor:pointer;box-shadow:var(--shadow)}
    .btn.primary{background:linear-gradient(180deg,rgba(34,211,238,.25),rgba(34,211,238,.08));border-color:rgba(34,211,238,.3)}
    :root[data-theme="light"] .btn{background:linear-gradient(180deg,rgba(148,163,184,.12),rgba(148,163,184,.05));border:1px solid rgba(148,163,184,.26)}
    :root[data-theme="light"] .btn.primary{background:linear-gradient(180deg,rgba(14,165,233,.22),rgba(14,165,233,.08));border-color:rgba(14,165,233,.3)}
    .btn:active{transform:translateY(1px)}

    nav{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);padding:12px;box-shadow:var(--shadow)}
    .search{display:flex;gap:8px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:8px}
    :root[data-theme="light"] .search{background:rgba(148,163,184,.12);border:1px solid rgba(148,163,184,.28)}
    .search input{flex:1;background:transparent;border:0;outline:0;color:var(--ink)}
    .menu{margin-top:12px;display:flex;flex-direction:column;gap:6px;}
    .menu a,
    .menu button{padding:10px 12px;border-radius:10px;border:1px solid transparent;display:flex;gap:10px;align-items:center;background:none;color:inherit;font:inherit;cursor:pointer;text-align:left}
    .menu button{width:100%;appearance:none;-webkit-appearance:none}
    .menu a.active,
    .menu a:hover,
    .menu button.active,
    .menu button:hover{background:rgba(167,139,250,.1);border-color:rgba(167,139,250,.25)}

    main{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);overflow:auto}
    .section{display:none;}
    .section.active{display:block}

    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:14px;box-shadow:var(--shadow)}
    :root[data-theme="light"] .card{border:1px solid rgba(15,23,42,.08)}
    .card h3{margin:0 0 6px 0;font-size:12px;color:var(--ink-dim);font-weight:600;letter-spacing:.3px;text-transform:uppercase}
    .card .value{font-size:24px;font-weight:800}
    .card.backlog-card{display:flex;flex-direction:column;gap:12px}
    .card.backlog-card .table-wrapper{flex:1;min-height:440px;overflow:auto}
    .tag{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid rgba(255,255,255,.12)}
    .tag.ok{background:rgba(16,185,129,.15);border-color:rgba(16,185,129,.35)}
    .tag.warn{background:rgba(245,158,11,.15);border-color:rgba(245,158,11,.35)}
    .tag.bad{background:rgba(239,68,68,.15);border-color:rgba(239,68,68,.35)}

    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th,td{padding:10px}
    thead th{text-align:left;font-size:12px;color:var(--ink-dim);text-transform:uppercase;letter-spacing:.4px}
    tbody tr{background:var(--panel);border:1px solid rgba(255,255,255,.06)}
    :root[data-theme="light"] tbody tr{border:1px solid rgba(15,23,42,.08)}
    tbody tr td:first-child{border-radius:12px 0 0 12px}
    tbody tr td:last-child{border-radius:0 12px 12px 0}
    .status{font-weight:700}
    .status.ok{color:var(--ok)}
    .status.warn{color:var(--warn)}
    .status.bad{color:var(--bad)}
    .detail-grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));margin:0}
    .detail-item{background:var(--muted);padding:12px 14px;border-radius:12px;display:flex;flex-direction:column;gap:6px}
    .detail-label{font-size:12px;letter-spacing:.08em;text-transform:uppercase;color:var(--ink-dim)}
    .detail-value{font-size:16px;font-weight:600;color:var(--ink)}
    .detail-note{white-space:pre-wrap}
    .detail-item.detail-wide{grid-column:1/-1}
    .detail-item .tag,.detail-item .status{align-self:flex-start}
    tbody tr.clickable{cursor:pointer;transition:background .2s ease,transform .2s ease}
    tbody tr.clickable:hover{background:rgba(167,139,250,.12);transform:translateY(-1px)}
    :root[data-theme="light"] tbody tr.clickable:hover{background:rgba(99,102,241,.12)}
    tbody tr.clickable:focus-visible{outline:2px solid var(--accent);outline-offset:2px}

    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:12px 0}
    .toolbar .input, .toolbar select{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:8px 10px;color:var(--ink)}
    :root:not([data-theme="light"]) .toolbar select{background:var(--panel);border:1px solid rgba(255,255,255,.14)}
    :root[data-theme="light"] .toolbar .input,
    :root[data-theme="light"] .toolbar select{background:rgba(148,163,184,.12);border:1px solid rgba(148,163,184,.28)}
    .toolbar select option{background:var(--panel);color:var(--ink)}
    :root[data-theme="light"] .toolbar select option{background:rgba(226,232,240,.95);color:var(--ink)}

    /* modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);padding:24px;overflow:auto}
    .modal.open{display:flex}
    .modal .sheet{width:min(720px,100%);background:var(--panel);border:1px solid rgba(255,255,255,.1);border-radius:18px;box-shadow:var(--shadow);max-height:calc(100vh - 48px);overflow:auto;display:flex;flex-direction:column}
    :root[data-theme="light"] .modal .sheet{border:1px solid rgba(15,23,42,.12)}
    .modal header{grid-column:auto;background:transparent;border:0;box-shadow:none;padding:16px}
    .modal .content{padding:16px;overflow:auto;flex:1 1 auto}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-size:12px;color:var(--ink-dim)}
    .field input,.field select,.field textarea{background:rgba(15,23,42,.6);border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:8px 10px;color:var(--ink)}
    .field input[type="checkbox"]{width:18px;height:18px;min-width:18px;padding:0;background:transparent;border:1px solid rgba(255,255,255,.25);border-radius:6px;accent-color:var(--accent)}
    .field textarea{min-height:140px;resize:vertical}
    .field select option{background:var(--panel);color:var(--ink)}
    .field.checkbox-field{flex-direction:row;align-items:center;gap:10px}
    .field.checkbox-field label{margin:0;font-size:14px;color:var(--ink);display:inline-flex;align-items:center;gap:10px;font-weight:500;cursor:pointer;user-select:none}
    :root[data-theme="light"] .field input,
    :root[data-theme="light"] .field select,
    :root[data-theme="light"] .field textarea{background:rgba(226,232,240,.6);border:1px solid rgba(148,163,184,.4)}
    :root[data-theme="light"] .field input[type="checkbox"]{background:transparent;border:1px solid rgba(148,163,184,.6)}
    :root[data-theme="light"] .field.checkbox-field label{color:var(--ink)}
    :root[data-theme="light"] .field select option{background:rgba(226,232,240,.95);color:var(--ink)}
    .actions{display:flex;gap:8px;justify-content:flex-end;padding:0 16px 16px}

    .attachments .attachment-actions{display:flex;flex-wrap:wrap;gap:8px}
    .attachment-list{list-style:none;margin:8px 0 0;padding:0;display:grid;gap:6px}
    .attachment-item{display:flex;align-items:center;justify-content:space-between;gap:12px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:8px 10px;font-size:13px}
    :root[data-theme="light"] .attachment-item{background:rgba(148,163,184,.12);border:1px solid rgba(148,163,184,.28)}
    .attachment-info{display:flex;flex-direction:column;gap:2px}
    .attachment-name{font-weight:600}
    .attachment-meta{font-size:12px;color:var(--ink-dim)}
    .attachment-remove{background:transparent;border:0;color:var(--ink-dim);cursor:pointer;padding:4px;border-radius:8px;line-height:1;font-size:16px}
    .attachment-remove:hover{color:var(--bad);background:rgba(239,68,68,.12)}
    :root[data-theme="light"] .attachment-remove:hover{background:rgba(220,38,38,.12)}
    .attachment-empty{font-size:12px;color:var(--ink-dim)}
    .spare-list{margin-top:8px}
    .spare-item{display:flex;justify-content:space-between;align-items:flex-start;gap:12px}
    .spare-item-actions{display:flex;align-items:center;gap:8px}
    .spare-item-main{display:flex;flex-direction:column;gap:4px}
    .spare-item-title{font-weight:600}
    .spare-item-meta{font-size:12px;color:var(--ink-dim)}
    .spare-item-note{font-size:12px;color:var(--ink)}
    .spare-empty-row{padding:18px;text-align:center;color:var(--ink-dim)}
    .camera-preview{margin-top:12px;display:flex;flex-direction:column;gap:12px;background:rgba(15,23,42,.6);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:12px}
    :root[data-theme="light"] .camera-preview{background:rgba(226,232,240,.6);border:1px solid rgba(148,163,184,.4)}
    .camera-preview video{width:100%;max-height:180px;border-radius:12px;background:black}
    .camera-actions{display:flex;flex-wrap:wrap;gap:8px}
    .attachment-link{color:var(--accent);text-decoration:underline;text-decoration-thickness:1px;text-decoration-color:rgba(167,139,250,.6);word-break:break-word;}
    .attachment-link:hover{color:var(--brand)}

    /* chips */
    .chip{border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);padding:6px 10px;border-radius:999px;font-size:12px}
    :root[data-theme="light"] .chip{border:1px solid rgba(148,163,184,.4);background:rgba(226,232,240,.6)}

    /* Bloc sites du tableau de bord */
    .sites-card{margin-bottom:16px}
    .site-panels{display:flex;gap:16px;flex-wrap:wrap;align-items:stretch}
    .site-panel{flex:1 1 320px;background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:18px;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:18px;min-width:260px}
    :root[data-theme="light"] .site-panel{border:1px solid rgba(15,23,42,.08)}
    .site-header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .site-title{font-size:16px;font-weight:700;letter-spacing:.4px;text-transform:uppercase}
    .site-badge{padding:4px 10px;border-radius:999px;background:rgba(167,139,250,.12);border:1px solid rgba(167,139,250,.28);font-size:12px}
    .site-section{display:flex;flex-direction:column;gap:12px}
    .site-section h4{margin:0;font-size:12px;color:var(--ink-dim);letter-spacing:.3px;text-transform:uppercase}
    .availability-summary{display:flex;align-items:center;gap:18px;flex-wrap:wrap}
    .availability-value{font-size:42px;font-weight:800;line-height:1}
    .availability-meta{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--ink-dim)}
    .trend-up{display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:rgba(16,185,129,.15);color:var(--ok);font-size:14px;font-weight:700}
    .legend-list{list-style:none;margin:0;padding:0;display:grid;gap:10px}
    .legend-list li{display:flex;align-items:center;justify-content:space-between;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:8px 12px;gap:12px}
    :root[data-theme="light"] .legend-list li{border:1px solid rgba(148,163,184,.18);background:rgba(148,163,184,.08)}
    .legend-item{display:flex;align-items:center;gap:10px;font-weight:600}
    .legend-count{font-variant-numeric:tabular-nums;font-weight:600}
    .dot{width:12px;height:12px;border-radius:50%;display:inline-block}
    .dot.ok{background:var(--ok)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}
    .dot.info{background:var(--brand)}
    .dot.attn{background:#facc15}

    @media (max-width:1200px){
      .app{grid-template-columns:minmax(180px,220px) 1fr}
    }

    @media (max-width:900px){
      .app{grid-template-columns:minmax(160px,200px) 1fr}
      .menu button{font-size:13px;padding:8px 10px}
    }

    @media (max-width:1100px){
      .kpis{grid-template-columns:repeat(2,minmax(0,1fr))}
      .grid{grid-template-columns:1fr}
      .site-panel{flex:1 1 260px}
    }

    @media (max-width:768px){
      .app{grid-template-columns:1fr;grid-template-rows:auto auto 1fr;gap:12px;padding:12px;height:auto;min-height:100vh}
      header{order:1;flex-wrap:wrap;gap:12px;padding:12px;height:auto}
      nav{order:2}
      main{order:3}
      .header-actions{width:100%;justify-content:flex-start;flex-wrap:wrap}
      .brand h1{font-size:15px}
      .menu{flex-direction:row;flex-wrap:wrap}
      .menu button{flex:1 1 140px;font-size:14px}
      .kpis{grid-template-columns:1fr}
      .card{padding:12px}
      .site-panels{flex-direction:column}
      .site-panel{min-width:0}
      .availability-value{font-size:32px}
    }

    @media (max-width:480px){
      .brand h1{font-size:14px}
      .btn{padding:6px 10px}
      .menu button{flex:1 1 120px;font-size:13px;padding:8px}
      .toolbar{flex-direction:column;align-items:stretch}
      .toolbar .input,
      .toolbar select{width:100%}
      table{font-size:13px}
      th,td{padding:8px}
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2l3 6 6 .75-4.5 4 1.2 6.25L12 16.5 6.3 19l1.2-6.25L3 8.75 9 8l3-6z" stroke="#0b1020" stroke-width="1.2" fill="white" opacity=".9"/>
          </svg>
        </div>
        <h1>GMAO STSI / GILLET</h1>
      </div>
      <div class="header-actions">
        <button class="btn" id="themeToggle" type="button" onclick="toggleTheme()" title="Basculer le thème" aria-pressed="false">🌙 Mode sombre</button>
        <button class="btn primary" onclick="openModal('diModal')">➕ Demande d’intervention</button>
      </div>
    </header>

    <nav>
      <div class="search" role="search">
        <span>🔎</span>
        <input id="globalSearch" placeholder="Rechercher… (machines, DI, pièces, fournisseurs, personnels)" oninput="globalFilter(this.value)">
      </div>
      <div class="menu" role="navigation">
        <button type="button" class="active" data-target="dashboard" aria-pressed="true" onclick="switchSection(event)">📊 Tableau de bord</button>
        <button type="button" data-target="parc" aria-pressed="false" onclick="switchSection(event)">🏭 Parc machines</button>
        <button type="button" data-target="interventions" aria-pressed="false" onclick="switchSection(event)">🛠️ Interventions</button>
        <button type="button" data-target="pieces" aria-pressed="false" onclick="switchSection(event)">🔩 Pièces détachées</button>
        <button type="button" data-target="preventif" aria-pressed="false" onclick="switchSection(event)">⏱️ Préventif</button>
        <button type="button" data-target="contacts" aria-pressed="false" onclick="switchSection(event)">📇 Contacts</button>
        <button type="button" data-target="personnels" aria-pressed="false" onclick="switchSection(event)">👤 Personnels</button>
      </div>
    </nav>

    <main>
      <!-- Dashboard -->
      <section id="dashboard" class="section active" aria-label="Tableau de bord">
        <!-- Encart sites -->
        <div class="card sites-card">
          <h3>Sites suivis</h3>
          <div class="site-panels">
            <article class="site-panel">
              <div class="site-header">
                <span class="site-title">Site A</span>
                <span class="site-badge">Zone Nord</span>
              </div>
              <div class="site-section">
                <h4>Taux de Disponibilité</h4>
                <div class="availability-summary">
                  <span class="availability-value">50%</span>
                  <div class="availability-meta">
                    <span class="trend-up" aria-hidden="true">▲</span>
                    <span>2 machine(s) à l’arrêt</span>
                  </div>
                </div>
              </div>
              <div class="site-section">
                <h4>Répartition des Demandes d’intervention</h4>
                <ul class="legend-list" aria-label="Répartition des demandes">
                  <li>
                    <div class="legend-item"><span class="dot bad"></span><span>Attente</span></div>
                    <span class="legend-count">6</span>
                  </li>
                  <li>
                    <div class="legend-item"><span class="dot info"></span><span>En cours</span></div>
                    <span class="legend-count">9</span>
                  </li>
                  <li>
                    <div class="legend-item"><span class="dot ok"></span><span>Terminé</span></div>
                    <span class="legend-count">21</span>
                  </li>
                </ul>
              </div>
              <div class="site-section">
                <h4>État des Équipements</h4>
                <ul class="legend-list" aria-label="État des équipements">
                  <li>
                    <div class="legend-item"><span class="dot ok"></span><span>Opérationnelles</span></div>
                    <span class="legend-count">32</span>
                  </li>
                  <li>
                    <div class="legend-item"><span class="dot warn"></span><span>En maintenance</span></div>
                    <span class="legend-count">5</span>
                  </li>
                  <li>
                    <div class="legend-item"><span class="dot bad"></span><span>À l’arrêt</span></div>
                    <span class="legend-count">2</span>
                  </li>
                  <li>
                    <div class="legend-item"><span class="dot attn"></span><span>Préventifs à réaliser</span></div>
                    <span class="legend-count">7</span>
                  </li>
                </ul>
              </div>
            </article>
            <article class="site-panel">
              <div class="site-header">
                <span class="site-title">Site B</span>
                <span class="site-badge">Zone Sud</span>
              </div>
              <div class="site-section">
                <h4>Taux de Disponibilité</h4>
                <div class="availability-summary">
                  <span class="availability-value">78%</span>
                  <div class="availability-meta">
                    <span class="trend-up" aria-hidden="true">▲</span>
                    <span>1 machine(s) à l’arrêt</span>
                  </div>
                </div>
              </div>
              <div class="site-section">
                <h4>Répartition des Demandes d’intervention</h4>
                <ul class="legend-list" aria-label="Répartition des demandes">
                  <li>
                    <div class="legend-item"><span class="dot bad"></span><span>Attente</span></div>
                    <span class="legend-count">3</span>
                  </li>
                  <li>
                    <div class="legend-item"><span class="dot info"></span><span>En cours</span></div>
                    <span class="legend-count">4</span>
                  </li>
                  <li>
                    <div class="legend-item"><span class="dot ok"></span><span>Terminé</span></div>
                    <span class="legend-count">15</span>
                  </li>
                </ul>
              </div>
              <div class="site-section">
                <h4>État des Équipements</h4>
                <ul class="legend-list" aria-label="État des équipements">
                  <li>
                    <div class="legend-item"><span class="dot ok"></span><span>Opérationnelles</span></div>
                    <span class="legend-count">18</span>
                  </li>
                  <li>
                    <div class="legend-item"><span class="dot warn"></span><span>En maintenance</span></div>
                    <span class="legend-count">3</span>
                  </li>
                  <li>
                    <div class="legend-item"><span class="dot bad"></span><span>À l’arrêt</span></div>
                    <span class="legend-count">1</span>
                  </li>
                  <li>
                    <div class="legend-item"><span class="dot attn"></span><span>Préventifs à réaliser</span></div>
                    <span class="legend-count">2</span>
                  </li>
                </ul>
              </div>
            </article>
          </div>
        </div>

        <div class="kpis">
          <div class="card"><h3>DI ouvertes</h3><div class="value">18</div><span class="tag warn">+3 cette semaine</span></div>
          <div class="card"><h3>Taux préventif réalisé</h3><div class="value">86%</div><span class="tag ok">Objectif ≥ 80%</span></div>
        </div>

        <div class="card backlog-card">
          <h3>Backlog par priorité</h3>
          <div class="toolbar">
            <span class="chip">P1: 4</span>
            <span class="chip">P2: 9</span>
            <span class="chip">P3: 5</span>
            <button class="btn" onclick="openModal('reportModal')">📈 Export rapide</button>
          </div>
          <div class="table-wrapper">
            <table aria-label="Backlog DI">
              <thead><tr><th>DI</th><th>Machine</th><th>Type</th><th>Priorité</th><th>Statut</th><th>Prévu</th></tr></thead>
              <tbody id="tblBacklog">
                <tr><td>DI-1024</td><td>DMU 70</td><td>Correctif</td><td>P1</td><td><span class="status warn">En cours</span></td><td>24/09/2025</td></tr>
                <tr><td>DI-1025</td><td>Tornos Deco</td><td>Qualité</td><td>P2</td><td><span class="status ok">Planifié</span></td><td>26/09/2025</td></tr>
                <tr><td>DI-1026</td><td>Compresseur KAESER</td><td>Sécurité</td><td>P1</td><td><span class="status bad">En retard</span></td><td>22/09/2025</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Parc -->
      <section id="parc" class="section" aria-label="Parc machines">
        <div class="toolbar">
          <input class="input" placeholder="Filtrer par zone…" oninput="filterTable('tblParc', this.value, [0])">
          <select onchange="filterTable('tblParc', this.value, [2])">
            <option value="">Tous fabricants</option>
            <option>DMG Mori</option>
            <option>Tornos</option>
            <option>Kaeser</option>
          </select>
          <button class="btn" onclick="openEquipmentForm('create')">➕ Ajouter équipement</button>
        </div>
        <table aria-label="Parc">
          <thead><tr><th>Zone</th><th>Machine</th><th>Fabricant</th><th>Modèle</th><th>Numéro série</th><th>Année</th></tr></thead>
          <tbody id="tblParc">
            <tr class="clickable" role="button" tabindex="0"
                aria-label="Voir le détail de Centre d'usinage 5 axes"
                data-zone="Fraisage"
                data-machine="Centre d'usinage 5 axes"
                data-fabricant="DMG Mori"
                data-modele="DMU 70"
                data-serie="FR-DMU70-2021"
                data-annee="2021">
              <td>Fraisage</td><td>Centre d'usinage 5 axes</td><td>DMG Mori</td><td>DMU 70</td><td>FR-DMU70-2021</td><td>2021</td>
            </tr>
            <tr class="clickable" role="button" tabindex="0"
                aria-label="Voir le détail de Tour CN polyvalent"
                data-zone="Tournage"
                data-machine="Tour CN polyvalent"
                data-fabricant="Tornos"
                data-modele="Deco 2000"
                data-serie="TN-DEC-2018"
                data-annee="2018">
              <td>Tournage</td><td>Tour CN polyvalent</td><td>Tornos</td><td>Deco 2000</td><td>TN-DEC-2018</td><td>2018</td>
            </tr>
            <tr class="clickable" role="button" tabindex="0"
                aria-label="Voir le détail de Compresseur d'air"
                data-zone="Utilities"
                data-machine="Compresseur d'air"
                data-fabricant="Kaeser"
                data-modele="SX 6"
                data-serie="KS-SX6-2016"
                data-annee="2016">
              <td>Utilities</td><td>Compresseur d'air</td><td>Kaeser</td><td>SX 6</td><td>KS-SX6-2016</td><td>2016</td>
            </tr>
          </tbody>
        </table>
      </section>

      <!-- Interventions -->
      <section id="interventions" class="section" aria-label="Interventions">
        <div class="toolbar">
          <select id="selType" class="input" onchange="filterTable('tblDI', this.value, [2])">
            <option value="">Type: Tous</option>
            <option>Correctif</option>
            <option>Curatif</option>
            <option>Préventif</option>
            <option>Amélioration</option>
            <option>Sécurité</option>
          </select>
          <select id="selPrio" class="input" onchange="filterTable('tblDI', this.value, [3])">
            <option value="">Priorité: Toutes</option>
            <option>P1</option>
            <option>P2</option>
            <option>P3</option>
          </select>
          <input class="input" placeholder="Rechercher travaux…" oninput="filterTable('tblDI', this.value, [5])">
        </div>
        <table aria-label="Interventions">
          <thead><tr><th>DI</th><th>Machine</th><th>Type</th><th>Priorité</th><th>Statut</th><th>Travaux</th><th>Prévu</th></tr></thead>
          <tbody id="tblDI">
            <tr class="clickable" role="button" tabindex="0" aria-label="Ouvrir l'intervention DI-1024"
                data-ot="DI-1024"
                data-machine="DMU 70"
                data-type="Curatif"
                data-priorite="P1"
                data-statut="En cours"
                data-status="En cours"
                data-travaux="Vibrations broche"
                data-demandeur-id="pers-bernard"
                data-demandeur="Claire Bernard"
                data-intervenant-id="pers-dupuis"
                data-intervenant="Yannis Dupuis"
                data-description="Remplacement des roulements de broche et réalignement."
                data-temps-intervention="3.5"
                data-temps-arret="2"
                data-resolution="2025-09-24"
                data-type-intervention="curatif">
              <td>DI-1024</td>
              <td>DMU 70</td>
              <td>Curatif</td>
              <td>P1</td>
              <td><span class="status warn">En cours</span></td>
              <td>Vibrations broche</td>
              <td>24/09/2025</td>
            </tr>
            <tr class="clickable" role="button" tabindex="0" aria-label="Ouvrir l'intervention DI-1025"
                data-ot="DI-1025"
                data-machine="Tornos Deco"
                data-type="Préventif"
                data-priorite="P2"
                data-statut="En attente"
                data-status="En attente"
                data-travaux="Contrôle géométrie"
                data-demandeur-id="pers-moreau"
                data-demandeur="Léa Moreau"
                data-intervenant-id=""
                data-intervenant=""
                data-description=""
                data-temps-intervention=""
                data-temps-arret="0"
                data-resolution=""
                data-type-intervention="preventif">
              <td>DI-1025</td>
              <td>Tornos Deco</td>
              <td>Préventif</td>
              <td>P2</td>
              <td><span class="status warn">En attente</span></td>
              <td>Contrôle géométrie</td>
              <td>26/09/2025</td>
            </tr>
            <tr class="clickable" role="button" tabindex="0" aria-label="Ouvrir l'intervention DI-1026"
                data-ot="DI-1026"
                data-machine="Compresseur KAESER"
                data-type="Sécurité"
                data-priorite="P1"
                data-statut="À surveiller"
                data-status="À surveiller"
                data-travaux="Remplacer cartouche"
                data-demandeur-id="pers-fontaine"
                data-demandeur="Samuel Fontaine"
                data-intervenant-id=""
                data-intervenant=""
                data-description="Attente de la pièce de rechange, intervention planifiée."
                data-temps-intervention="1.5"
                data-temps-arret="1.5"
                data-resolution="2025-09-22"
                data-type-intervention="correctif">
              <td>DI-1026</td>
              <td>Compresseur KAESER</td>
              <td>Sécurité</td>
              <td>P1</td>
              <td><span class="status bad">À surveiller</span></td>
              <td>Remplacer cartouche</td>
              <td>22/09/2025</td>
            </tr>
          </tbody>
        </table>
      </section>

      <!-- Pièces détachées -->
      <section id="pieces" class="section" aria-label="Pièces détachées">
        <div class="toolbar">
          <input id="piecesSearch" class="input" placeholder="Rechercher une pièce…" oninput="renderSpareParts()">
          <select id="piecesStatusFilter" class="input" onchange="renderSpareParts()">
            <option value="">Statut : Tous</option>
            <option value="ordered">Commandée</option>
            <option value="used">Utilisée</option>
          </select>
          <button class="btn" type="button" onclick="openSparePartModal('pieces')">➕ Ajouter une pièce</button>
        </div>
        <table aria-label="Pièces détachées">
          <thead>
          <tr><th>Référence</th><th>Désignation</th><th>DI</th><th>Machine</th><th>Statut</th><th>Quantité</th><th>Date</th><th>Commentaire</th></tr>
          </thead>
          <tbody id="tblPieces"></tbody>
        </table>
      </section>

      <!-- Préventif -->
      <section id="preventif" class="section" aria-label="Préventif">
        <div class="toolbar">
          <select class="input" onchange="filterTable('tblPrev', this.value, [2])">
            <option value="">Périodicité</option>
            <option>Hebdo</option>
            <option>Mensuel</option>
            <option>Trimestriel</option>
          </select>
        <button class="btn" onclick="openModal('planModal')">⚙️ Générer DI préventives</button>
        </div>
        <table aria-label="Plan préventif">
          <thead><tr><th>Plan</th><th>Machine</th><th>Périodicité</th><th>Dernier</th><th>Prochain</th><th>État</th></tr></thead>
        <tbody id="tblPrev">
          <tr class="clickable" role="button" tabindex="0"
              aria-label="Voir le plan préventif PV-001"
              data-plan="PV-001"
              data-machine="DMU 70"
              data-periodicite="Mensuel"
              data-dernier="28/08/2025"
              data-prochain="28/09/2025"
              data-etat="À l'heure"
              data-etat-class="ok"
              data-description="Vérifier les niveaux de lubrifiant, remplacer le filtre et contrôler les vibrations de la broche.">
            <td>PV-001</td><td>DMU 70</td><td>Mensuel</td><td>28/08/2025</td><td>28/09/2025</td><td><span class="status ok">À l'heure</span></td>
          </tr>
          <tr class="clickable" role="button" tabindex="0"
              aria-label="Voir le plan préventif PV-017"
              data-plan="PV-017"
              data-machine="Tornos Deco"
              data-periodicite="Hebdo"
              data-dernier="18/09/2025"
              data-prochain="25/09/2025"
              data-etat="À lancer"
              data-etat-class="warn"
              data-description="Dégraisser les glissières, vérifier les jeux mécaniques et contrôler la tension des courroies.">
            <td>PV-017</td><td>Tornos Deco</td><td>Hebdo</td><td>18/09/2025</td><td>25/09/2025</td><td><span class="status warn">À lancer</span></td>
          </tr>
          <tr class="clickable" role="button" tabindex="0"
              aria-label="Voir le plan préventif PV-023"
              data-plan="PV-023"
              data-machine="Compresseur KAESER"
              data-periodicite="Trimestriel"
              data-dernier="10/07/2025"
              data-prochain="10/10/2025"
              data-etat="OK"
              data-etat-class="ok"
              data-description="Couper l'alimentation, purger la cuve et remplacer la cartouche filtrante principale.">
            <td>PV-023</td><td>Compresseur KAESER</td><td>Trimestriel</td><td>10/07/2025</td><td>10/10/2025</td><td><span class="status ok">OK</span></td>
          </tr>
        </tbody>
        </table>
      </section>

      <!-- Contacts -->
      <section id="contacts" class="section" aria-label="Contacts">
        <div class="toolbar">
          <input class="input" placeholder="Rechercher fournisseur/intervenant…" oninput="filterTable('tblContacts', this.value, [0,1,2,3])">
          <button class="btn" onclick="openContactForm('create')">➕ Nouveau contact</button>
        </div>
        <table aria-label="Contacts">
          <thead><tr><th>Entreprise</th><th>Activité</th><th>Contact</th><th>Email</th><th>Téléphone</th></tr></thead>
          <tbody id="tblContacts">
            <tr class="clickable" role="button" tabindex="0"
                aria-label="Voir le contact AirTech"
                data-entreprise="AirTech"
                data-activite="Compresseurs"
                data-contact="J. Martin"
                data-email="service@airtech.tld"
                data-telephone="+33 4 12 34 56 78">
              <td>AirTech</td><td>Compresseurs</td><td>J. Martin</td><td>service@airtech.tld</td><td>+33 4 12 34 56 78</td>
            </tr>
            <tr class="clickable" role="button" tabindex="0"
                aria-label="Voir le contact MecaPro"
                data-entreprise="MecaPro"
                data-activite="Fourniture Mécanique"
                data-contact="S. Leroy"
                data-email="contact@mecapro.tld"
                data-telephone="+33 1 98 76 54 32">
              <td>MecaPro</td><td>Fourniture Mécanique</td><td>S. Leroy</td><td>contact@mecapro.tld</td><td>+33 1 98 76 54 32</td>
            </tr>
          </tbody>
        </table>
      </section>

      <!-- Personnels -->
      <section id="personnels" class="section" aria-label="Personnels">
        <div class="toolbar">
          <input class="input" placeholder="Rechercher un personnel…" oninput="filterTable('tblPersonnel', this.value, [0,1,2,3,4])">
          <button class="btn" onclick="openPersonnelForm('create')">➕ Nouveau personnel</button>
        </div>
        <table aria-label="Personnels">
          <thead><tr><th>Nom</th><th>Prénom</th><th>Poste</th><th>Téléphone</th><th>Email</th></tr></thead>
          <tbody id="tblPersonnel">
            <tr class="clickable" role="button" tabindex="0"
                aria-label="Voir la fiche de Claire Bernard"
                data-personnel-id="pers-bernard"
                data-nom="Bernard"
                data-prenom="Claire"
                data-poste="Responsable maintenance"
                data-telephone="+33 4 44 55 66 77"
                data-email="claire.bernard@gillet.tld">
              <td>Bernard</td><td>Claire</td><td>Responsable maintenance</td><td>+33 4 44 55 66 77</td><td>claire.bernard@gillet.tld</td>
            </tr>
            <tr class="clickable" role="button" tabindex="0"
                aria-label="Voir la fiche de Yannis Dupuis"
                data-personnel-id="pers-dupuis"
                data-nom="Dupuis"
                data-prenom="Yannis"
                data-poste="Technicien polyvalent"
                data-telephone="+33 6 12 34 56 78"
                data-email="y.dupuis@gillet.tld">
              <td>Dupuis</td><td>Yannis</td><td>Technicien polyvalent</td><td>+33 6 12 34 56 78</td><td>y.dupuis@gillet.tld</td>
            </tr>
            <tr class="clickable" role="button" tabindex="0"
                aria-label="Voir la fiche de Léa Moreau"
                data-personnel-id="pers-moreau"
                data-nom="Moreau"
                data-prenom="Léa"
                data-poste="Opératrice qualité"
                data-telephone="+33 6 98 76 54 32"
                data-email="lea.moreau@gillet.tld">
              <td>Moreau</td><td>Léa</td><td>Opératrice qualité</td><td>+33 6 98 76 54 32</td><td>lea.moreau@gillet.tld</td>
            </tr>
            <tr class="clickable" role="button" tabindex="0"
                aria-label="Voir la fiche de Samuel Fontaine"
                data-personnel-id="pers-fontaine"
                data-nom="Fontaine"
                data-prenom="Samuel"
                data-poste="Responsable production"
                data-telephone="+33 1 23 45 67 89"
                data-email="samuel.fontaine@gillet.tld">
              <td>Fontaine</td><td>Samuel</td><td>Responsable production</td><td>+33 1 23 45 67 89</td><td>samuel.fontaine@gillet.tld</td>
            </tr>
          </tbody>
        </table>
      </section>

    </main>
  </div>

  <!-- Modals -->
  <div class="modal" id="otModal" role="dialog" aria-modal="true" aria-hidden="true" aria-label="Créer une DI">
    <div class="sheet">
      <header>
        <div class="brand"><div class="logo" style="width:28px;height:28px"></div><h1>Nouvelle demande d’intervention</h1></div>
      </header>
      <div class="content">
        <div class="grid">
          <div class="field"><label>Machine</label><input placeholder="ex. DMU 70"/></div>
          <div class="field"><label>Type</label><select><option>Correctif</option><option>Curatif</option><option>Préventif</option><option>Amélioration</option><option>Sécurité</option></select></div>
          <div class="field"><label>Priorité</label><select><option>P1</option><option>P2</option><option>P3</option></select></div>
          <div class="field"><label>Prévu le</label><input type="date"/></div>
          <div class="field" style="grid-column:1/-1"><label>Travaux à effectuer</label><textarea rows="3" placeholder="Décrire la demande…"></textarea></div>
        </div>
      </div>
      <div class="actions">
        <button class="btn" onclick="closeModal('otModal')">Annuler</button>
        <button class="btn primary" onclick="closeModal('otModal')">Créer</button>
      </div>
    </div>
  </div>

  <div class="modal" id="diModal" role="dialog" aria-modal="true" aria-hidden="true" aria-label="Créer une demande d’intervention">
    <div class="sheet">
      <header>
        <div class="brand">
          <div class="logo" style="width:28px;height:28px"></div>
          <h1>Nouvelle demande d’intervention</h1>
        </div>
      </header>
      <div class="content">
        <div class="grid">
          <div class="field">
            <label>Date de la demande</label>
            <input type="date"/>
          </div>
          <div class="field">
            <label for="diDemandeur">Demandeur</label>
            <select id="diDemandeur">
              <option value="">Sélectionner un demandeur…</option>
            </select>
          </div>
          <div class="field">
            <label for="diMachine">Machine</label>
            <select id="diMachine">
              <option value="">Sélectionner une machine…</option>
              <option value="DMU 70">DMU 70</option>
              <option value="Tornos Deco">Tornos Deco</option>
              <option value="Compresseur KAESER">Compresseur KAESER</option>
            </select>
          </div>
          <div class="field">
            <label for="diType">Type</label>
            <select id="diType">
              <option value="">Sélectionner un type…</option>
            </select>
          </div>
          <div class="field">
            <label>Priorité</label>
            <select>
              <option value="P1">P1 — Urgent (machine à l’arrêt)</option>
              <option value="P2">P2 — Moyen (défaut sans interruption)</option>
              <option value="P3">P3 — Faible</option>
            </select>
          </div>
          <div class="field checkbox-field">
            <label for="diMachineStop">
              <input type="checkbox" id="diMachineStop"/>
              Machine à l’arrêt
            </label>
          </div>
          <div class="field" style="grid-column:1/-1">
            <label>Travaux à effectuer</label>
            <textarea rows="3" placeholder="Décrire les travaux demandés…"></textarea>
          </div>
          <div class="field attachments" style="grid-column:1/-1">
            <label>Pièces jointes</label>
            <div class="attachment-actions">
              <input id="diAttachmentInput" type="file" accept="image/*,.pdf,.doc,.docx,.txt,.xlsx,.xls,.ppt,.pptx" multiple hidden>
              <button type="button" class="btn" id="diUploadButton">📎 Ajouter un fichier</button>
              <button type="button" class="btn" id="diCameraButton" aria-expanded="false">📷 Prendre une photo</button>
            </div>
            <ul id="diAttachmentList" class="attachment-list"></ul>
            <div class="camera-preview" id="diCameraPreview" hidden>
              <video id="diCameraVideo" autoplay playsinline></video>
              <div class="camera-actions">
                <button type="button" class="btn primary" id="diCaptureBtn">📸 Capturer</button>
                <button type="button" class="btn" id="diCloseCameraBtn">✖️ Fermer la caméra</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="actions">
        <button class="btn" onclick="closeModal('diModal')">Annuler</button>
        <button class="btn primary" onclick="submitDiModal()">Envoyer</button>
      </div>
    </div>
  </div>

  <div class="modal" id="interventionModal" role="dialog" aria-modal="true" aria-hidden="true" aria-label="Compte-rendu d'intervention">
    <div class="sheet">
      <header>
        <div class="brand">
          <div class="logo" style="width:28px;height:28px"></div>
          <h1>Compte-rendu d'intervention</h1>
        </div>
      </header>
      <div class="content">
        <div class="grid">
          <div class="field">
            <label for="interventionDi">DI</label>
            <input id="interventionDi" type="text" readonly>
          </div>
          <div class="field">
            <label for="interventionMachine">Machine</label>
            <input id="interventionMachine" type="text" readonly>
          </div>
          <div class="field">
            <label for="interventionDemandeur">Demandeur</label>
            <select id="interventionDemandeur" disabled>
              <option value="">Sélectionner un demandeur…</option>
            </select>
          </div>
          <div class="field">
            <label for="interventionIntervenant">Intervenant</label>
            <select id="interventionIntervenant">
              <option value="">Sélectionner un intervenant…</option>
            </select>
          </div>
          <div class="field">
            <label for="interventionStatut">Statut</label>
            <select id="interventionStatut">
              <option value="En attente">En attente</option>
              <option value="En cours">En cours</option>
              <option value="À surveiller">À surveiller</option>
              <option value="Terminée">Terminée</option>
            </select>
          </div>
          <div class="field">
            <label for="interventionPriorite">Priorité</label>
            <select id="interventionPriorite">
              <option value="P1">P1 — Urgent (machine à l’arrêt)</option>
              <option value="P2">P2 — Moyen (défaut sans interruption)</option>
              <option value="P3">P3 — Faible</option>
            </select>
          </div>
          <div class="field">
            <label for="interventionType">Type d’intervention</label>
            <select id="interventionType">
              <option value="correctif">Correctif</option>
              <option value="curatif">Curatif</option>
              <option value="preventif">Préventif</option>
              <option value="amelioration">Amélioration</option>
              <option value="securite">Sécurité</option>
            </select>
          </div>
          <div class="field" style="grid-column:1/-1">
            <label for="interventionDescription">Intervention réalisée</label>
            <textarea id="interventionDescription" rows="4" placeholder="Décrire les actions menées…"></textarea>
          </div>
          <div class="field attachments" style="grid-column:1/-1">
            <label>Pièces jointes</label>
            <div class="attachment-actions">
              <input id="interventionAttachmentInput" type="file" accept="image/*,.pdf,.doc,.docx,.txt,.xlsx,.xls,.ppt,.pptx" multiple hidden>
              <button type="button" class="btn" id="interventionUploadButton">📎 Ajouter un fichier</button>
              <button type="button" class="btn" id="interventionCameraButton" aria-expanded="false">📷 Prendre une photo</button>
            </div>
            <ul id="interventionAttachmentList" class="attachment-list"></ul>
            <div class="camera-preview" id="interventionCameraPreview" hidden>
              <video id="interventionCameraVideo" autoplay playsinline></video>
              <div class="camera-actions">
                <button type="button" class="btn primary" id="interventionCaptureBtn">📸 Capturer</button>
                <button type="button" class="btn" id="interventionCloseCameraBtn">✖️ Fermer la caméra</button>
              </div>
            </div>
          </div>
          <div class="field attachments" style="grid-column:1/-1">
            <label>Pièces détachées liées</label>
            <div class="attachment-actions">
              <button type="button" class="btn" id="interventionAddPieceBtn">➕ Ajouter une pièce</button>
              <button type="button" class="btn" id="interventionSearchPieceBtn" onclick="ouvrirRecherchePiece()">🔍 Rechercher une pièce</button>
            </div>
            <p id="interventionPiecesEmpty" class="attachment-empty">Aucune pièce liée pour le moment.</p>
            <ul id="interventionPiecesList" class="attachment-list spare-list"></ul>
          </div>
          <div class="field">
            <label for="interventionDuree">Temps d’intervention (h)</label>
            <input id="interventionDuree" type="number" min="0" step="0.25" placeholder="0">
          </div>
          <div class="field">
            <label for="interventionArret">Temps d’arrêt machine (h)</label>
            <input id="interventionArret" type="number" min="0" step="0.25" placeholder="0">
          </div>
          <div class="field">
            <label for="interventionResolution">Date de résolution</label>
            <input id="interventionResolution" type="date">
          </div>
        </div>
      </div>
      <div class="actions">
        <button class="btn" type="button" onclick="closeModal('interventionModal')">Fermer</button>
        <button class="btn primary" type="button" onclick="saveInterventionDetails()">Enregistrer</button>
      </div>
    </div>
  </div>

  <div class="modal" id="parcDetailModal" role="dialog" aria-modal="true" aria-hidden="true" aria-label="Détails de l'équipement">
    <div class="sheet">
      <header>
        <div class="brand"><div class="logo" style="width:28px;height:28px"></div><h1>Détails équipement</h1></div>
      </header>
      <div class="content">
        <div class="detail-grid">
          <div class="detail-item"><span class="detail-label">Zone</span><span class="detail-value" id="parcDetailZone">—</span></div>
          <div class="detail-item"><span class="detail-label">Machine</span><span class="detail-value" id="parcDetailMachine">—</span></div>
          <div class="detail-item"><span class="detail-label">Fabricant</span><span class="detail-value" id="parcDetailFabricant">—</span></div>
          <div class="detail-item"><span class="detail-label">Modèle</span><span class="detail-value" id="parcDetailModele">—</span></div>
          <div class="detail-item"><span class="detail-label">Numéro de série</span><span class="detail-value" id="parcDetailSerie">—</span></div>
          <div class="detail-item"><span class="detail-label">Année</span><span class="detail-value" id="parcDetailAnnee">—</span></div>
        </div>
      </div>
      <div class="actions">
        <button class="btn" type="button" onclick="closeModal('parcDetailModal')">Fermer</button>
        <button class="btn primary" type="button" onclick="beginEditEquipment()">Modifier</button>
      </div>
    </div>
  </div>

  <div class="modal" id="pieceDetailModal" role="dialog" aria-modal="true" aria-hidden="true" aria-label="Détails de la pièce détachée">
    <div class="sheet">
      <header>
        <div class="brand"><div class="logo" style="width:28px;height:28px"></div><h1>Pièce détachée</h1></div>
      </header>
      <div class="content">
        <div class="detail-grid">
          <div class="detail-item"><span class="detail-label">Référence</span><span class="detail-value" id="pieceDetailReference">—</span></div>
          <div class="detail-item"><span class="detail-label">Désignation</span><span class="detail-value" id="pieceDetailDesignation">—</span></div>
          <div class="detail-item"><span class="detail-label">DI liée</span><span class="detail-value" id="pieceDetailDi">—</span></div>
          <div class="detail-item"><span class="detail-label">Machine</span><span class="detail-value" id="pieceDetailMachine">—</span></div>
          <div class="detail-item"><span class="detail-label">Statut</span><span class="detail-value"><span id="pieceDetailStatus" class="tag">—</span></span></div>
          <div class="detail-item"><span class="detail-label">Quantité</span><span class="detail-value" id="pieceDetailQuantity">—</span></div>
          <div class="detail-item"><span class="detail-label">Date</span><span class="detail-value" id="pieceDetailDate">—</span></div>
          <div class="detail-item detail-wide"><span class="detail-label">Commentaire</span><span class="detail-value detail-note" id="pieceDetailNote">—</span></div>
        </div>
      </div>
      <div class="actions">
        <button class="btn" type="button" onclick="closeModal('pieceDetailModal')">Fermer</button>
        <button class="btn primary" type="button" onclick="beginEditSparePart()">Modifier</button>
      </div>
    </div>
  </div>

  <div class="modal" id="preventifDetailModal" role="dialog" aria-modal="true" aria-hidden="true" aria-label="Plan préventif">
    <div class="sheet">
      <header>
        <div class="brand"><div class="logo" style="width:28px;height:28px"></div><h1>Plan préventif</h1></div>
      </header>
      <div class="content">
        <form id="preventifForm">
          <div class="grid">
            <div class="field"><label for="preventif-plan">Plan</label><input id="preventif-plan" type="text" required></div>
            <div class="field"><label for="preventif-machine">Machine</label>
              <select id="preventif-machine" required>
                <option value="">Sélectionner une machine…</option>
              </select>
            </div>
            <div class="field"><label for="preventif-periodicite">Périodicité</label>
              <select id="preventif-periodicite">
                <option value="">Sélectionner…</option>
                <option value="Mensuel">Mensuel</option>
                <option value="Trimestriel">Trimestriel</option>
                <option value="Semestriel">Semestriel</option>
                <option value="Annuel">Annuel</option>
              </select>
            </div>
            <div class="field"><label for="preventif-dernier">Dernier passage</label><input id="preventif-dernier" type="date"></div>
            <div class="field"><label for="preventif-prochain">Prochain passage</label><input id="preventif-prochain" type="date"></div>
            <div class="field"><label for="preventif-etat">État</label><input id="preventif-etat" type="text" readonly></div>
            <div class="field" style="grid-column:1/-1"><label for="preventif-description">Description détaillée</label><textarea id="preventif-description" rows="4" placeholder="Décrire les étapes de la maintenance préventive…"></textarea></div>
            <div class="field attachments" style="grid-column:1/-1">
              <label>Documents</label>
              <div class="attachment-actions">
                <input id="preventifDocInput" type="file" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt" multiple hidden>
                <button type="button" class="btn" id="preventifDocUpload">📎 Ajouter un document</button>
              </div>
              <ul id="preventifDocList" class="attachment-list"></ul>
            </div>
            <div class="field attachments" style="grid-column:1/-1">
              <label>Photos</label>
              <div class="attachment-actions">
                <input id="preventifPhotoInput" type="file" accept="image/*" multiple hidden>
                <button type="button" class="btn" id="preventifPhotoUpload">🖼️ Ajouter une photo</button>
                <button type="button" class="btn" id="preventifPhotoCameraButton" aria-expanded="false">📷 Prendre une photo</button>
              </div>
              <ul id="preventifPhotoList" class="attachment-list"></ul>
              <div class="camera-preview" id="preventifPhotoPreview" hidden>
                <video id="preventifPhotoVideo" autoplay playsinline></video>
                <div class="camera-actions">
                  <button type="button" class="btn primary" id="preventifPhotoCapture">📸 Capturer</button>
                  <button type="button" class="btn" id="preventifPhotoClose">✖️ Fermer</button>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="actions">
        <button class="btn" type="button" onclick="deletePreventif()">🗑️ Supprimer</button>
        <button class="btn" type="button" id="preventifEditButton">Modifier</button>
        <button class="btn" type="button" onclick="closeModal('preventifDetailModal')">Fermer</button>
        <button class="btn" type="button" onclick="createPreventifDemand()">📨 Envoyer demande d’intervention</button>
        <button class="btn primary" type="submit" form="preventifForm" id="preventifModalSubmit">Enregistrer</button>
      </div>
    </div>
  </div>

  <div class="modal" id="contactDetailModal" role="dialog" aria-modal="true" aria-hidden="true" aria-label="Détails du contact">
    <div class="sheet">
      <header>
        <div class="brand"><div class="logo" style="width:28px;height:28px"></div><h1>Contact</h1></div>
      </header>
      <div class="content">
        <div class="detail-grid">
          <div class="detail-item"><span class="detail-label">Entreprise</span><span class="detail-value" id="contactDetailEntreprise">—</span></div>
          <div class="detail-item"><span class="detail-label">Activité</span><span class="detail-value" id="contactDetailActivite">—</span></div>
          <div class="detail-item"><span class="detail-label">Contact</span><span class="detail-value" id="contactDetailNom">—</span></div>
          <div class="detail-item"><span class="detail-label">Email</span><span class="detail-value" id="contactDetailEmail">—</span></div>
          <div class="detail-item"><span class="detail-label">Téléphone</span><span class="detail-value" id="contactDetailTelephone">—</span></div>
        </div>
      </div>
      <div class="actions">
        <button class="btn" type="button" onclick="closeModal('contactDetailModal')">Fermer</button>
        <button class="btn primary" type="button" onclick="beginEditContact()">Modifier</button>
      </div>
    </div>
  </div>

  <div class="modal" id="pieceModal" role="dialog" aria-modal="true" aria-hidden="true" aria-label="Ajouter une pièce détachée">
    <div class="sheet">
      <header>
        <div class="brand"><div class="logo" style="width:28px;height:28px"></div><h1 id="pieceModalTitle">Nouvelle pièce détachée</h1></div>
      </header>
      <div class="content">
        <form id="pieceForm">
          <p id="pieceContextInfo" class="spare-item-meta">Associer une pièce détachée au stock ou à une intervention.</p>
          <div class="grid">
            <div class="field"><label for="pieceReference">Référence</label><input id="pieceReference" type="text" placeholder="Ex. RB-0001"></div>
            <div class="field"><label for="pieceDesignation">Désignation</label><input id="pieceDesignation" type="text" required placeholder="Nom de la pièce"></div>
            <div class="field"><label for="pieceDi">DI liée</label><input id="pieceDi" type="text" placeholder="Numéro de DI"></div>
            <div class="field"><label for="pieceMachine">Machine</label><input id="pieceMachine" type="text" placeholder="Machine concernée"></div>
            <div class="field"><label for="pieceStatus">Statut</label><select id="pieceStatus"><option value="ordered">Commandée</option><option value="used">Utilisée</option></select></div>
            <div class="field"><label for="pieceQuantity">Quantité</label><input id="pieceQuantity" type="number" min="1" step="1" value="1"></div>
            <div class="field"><label for="pieceDate">Date</label><input id="pieceDate" type="date"></div>
            <div class="field" style="grid-column:1/-1"><label for="pieceNote">Commentaire</label><textarea id="pieceNote" rows="3" placeholder="Précisions sur la commande ou l'utilisation…"></textarea></div>
          </div>
        </form>
      </div>
      <div class="actions">
        <button class="btn" type="button" onclick="closeModal('pieceModal')">Annuler</button>
        <button class="btn primary" type="submit" form="pieceForm" id="pieceModalSubmit">Enregistrer</button>
      </div>
    </div>
  </div>

  <div class="modal" id="spareSearchModal" role="dialog" aria-modal="true" aria-hidden="true" aria-label="Rechercher une pièce détachée">
    <div class="sheet">
      <header>
        <div class="brand"><div class="logo" style="width:28px;height:28px"></div><h1>Rechercher une pièce détachée</h1></div>
      </header>
      <div class="content">
        <div class="field" style="margin-bottom:12px;">
          <label for="spareSearchInput">Recherche</label>
          <input type="search" id="spareSearchInput" placeholder="Nom, référence ou mot-clé…">
        </div>
        <p id="spareSearchEmpty" class="attachment-empty" hidden>Aucune pièce ne correspond à votre recherche.</p>
        <ul id="spareSearchList" class="attachment-list spare-list"></ul>
      </div>
      <div class="actions">
        <button class="btn" type="button" onclick="fermerRecherchePiece()">Fermer</button>
      </div>
    </div>
  </div>

  <div class="modal" id="equipModal" role="dialog" aria-modal="true" aria-hidden="true" aria-label="Ajouter un équipement">
    <div class="sheet">
      <header>
        <div class="brand"><div class="logo" style="width:28px;height:28px"></div><h1 id="equipModalTitle">Ajouter équipement</h1></div>
      </header>
      <div class="content">
        <form id="equipForm">
          <div class="grid">
            <div class="field"><label for="equip-zone">Zone</label><input id="equip-zone" type="text" placeholder="Zone de l'équipement"></div>
            <div class="field"><label for="equip-machine">Machine</label><input id="equip-machine" type="text" placeholder="Nom de la machine"></div>
            <div class="field"><label for="equip-fabricant">Fabricant</label><input id="equip-fabricant" type="text" placeholder="Fabricant"></div>
            <div class="field"><label for="equip-modele">Modèle</label><input id="equip-modele" type="text" placeholder="Référence ou modèle"></div>
            <div class="field"><label for="equip-serial">Numéro de série</label><input id="equip-serial" type="text" placeholder="Numéro de série"></div>
            <div class="field"><label for="equip-annee">Année</label><input id="equip-annee" type="number" inputmode="numeric" min="1900" max="2100" placeholder="Année de mise en service"></div>
          </div>
        </form>
      </div>
      <div class="actions">
        <button class="btn" type="button" onclick="closeModal('equipModal')">Fermer</button>
        <button class="btn primary" type="submit" form="equipForm" id="equipModalSubmit">Enregistrer</button>
      </div>
    </div>
  </div>
  <div class="modal" id="contactModal" role="dialog" aria-modal="true" aria-hidden="true" aria-label="Créer un contact">
    <div class="sheet">
      <header>
        <div class="brand"><div class="logo" style="width:28px;height:28px"></div><h1 id="contactModalTitle">Nouveau contact</h1></div>
      </header>
      <div class="content">
        <form id="contactForm">
          <div class="grid">
            <div class="field"><label for="contact-company">Entreprise</label><input id="contact-company" type="text"></div>
            <div class="field"><label for="contact-activity">Activité</label><input id="contact-activity" type="text"></div>
            <div class="field"><label for="contact-name">Contact</label><input id="contact-name" type="text"></div>
            <div class="field"><label for="contact-email">Email</label><input id="contact-email" type="email"></div>
            <div class="field"><label for="contact-phone">Téléphone</label><input id="contact-phone" type="text"></div>
          </div>
        </form>
      </div>
      <div class="actions">
        <button class="btn" type="button" onclick="closeModal('contactModal')">Fermer</button>
        <button class="btn primary" type="submit" form="contactForm" id="contactModalSubmit">Enregistrer</button>
      </div>
    </div>
  </div>

  <div class="modal" id="personnelDetailModal" role="dialog" aria-modal="true" aria-hidden="true" aria-label="Fiche personnel">
    <div class="sheet">
      <header>
        <div class="brand"><div class="logo" style="width:28px;height:28px"></div><h1>Personnel</h1></div>
      </header>
      <div class="content">
        <div class="detail-grid">
          <div class="detail-item"><span class="detail-label">Nom</span><span class="detail-value" id="personnelDetailNom">—</span></div>
          <div class="detail-item"><span class="detail-label">Prénom</span><span class="detail-value" id="personnelDetailPrenom">—</span></div>
          <div class="detail-item"><span class="detail-label">Poste</span><span class="detail-value" id="personnelDetailPoste">—</span></div>
          <div class="detail-item"><span class="detail-label">Téléphone</span><span class="detail-value" id="personnelDetailTelephone">—</span></div>
          <div class="detail-item detail-wide"><span class="detail-label">Email</span><span class="detail-value" id="personnelDetailEmail">—</span></div>
        </div>
      </div>
      <div class="actions">
        <button class="btn" type="button" onclick="closeModal('personnelDetailModal')">Fermer</button>
        <button class="btn" type="button" onclick="deletePersonnel()">🗑️ Supprimer</button>
        <button class="btn primary" type="button" onclick="beginEditPersonnel()">Modifier</button>
      </div>
    </div>
  </div>

  <div class="modal" id="personnelModal" role="dialog" aria-modal="true" aria-hidden="true" aria-label="Créer un personnel">
    <div class="sheet">
      <header>
        <div class="brand"><div class="logo" style="width:28px;height:28px"></div><h1 id="personnelModalTitle">Nouveau personnel</h1></div>
      </header>
      <div class="content">
        <form id="personnelForm">
          <div class="grid">
            <div class="field"><label for="personnel-lastname">Nom</label><input id="personnel-lastname" type="text" required></div>
            <div class="field"><label for="personnel-firstname">Prénom</label><input id="personnel-firstname" type="text" required></div>
            <div class="field"><label for="personnel-role">Poste</label><input id="personnel-role" type="text"></div>
            <div class="field"><label for="personnel-phone">Téléphone</label><input id="personnel-phone" type="text"></div>
            <div class="field"><label for="personnel-email">Email</label><input id="personnel-email" type="email"></div>
          </div>
        </form>
      </div>
      <div class="actions">
        <button class="btn" type="button" onclick="closeModal('personnelModal')">Annuler</button>
        <button class="btn primary" type="submit" form="personnelForm" id="personnelModalSubmit">Enregistrer</button>
      </div>
    </div>
  </div>
  <div class="modal" id="planModal" role="dialog" aria-modal="true" aria-hidden="true" aria-label="Générer des DI préventives"><div class="sheet"><header><div class="brand"><div class="logo" style="width:28px;height:28px"></div><h1>Générer DI préventives</h1></div></header><div class="content"><p>Sélectionner l'horizon de planification et la périodicité.</p><div class="grid"><div class="field"><label>Horizon (jours)</label><input type="number" value="30"></div><div class="field"><label>Inclure retard</label><select><option>Oui</option><option>Non</option></select></div></div></div><div class="actions"><button class="btn" onclick="closeModal('planModal')">Fermer</button><button class="btn primary" onclick="closeModal('planModal')">Générer</button></div></div></div>
  <div class="modal" id="reportModal" role="dialog" aria-modal="true" aria-hidden="true" aria-label="Exporter les données"><div class="sheet"><header><div class="brand"><div class="logo" style="width:28px;height:28px"></div><h1>Export rapide</h1></div></header><div class="content"><p>Ce prototype exportera un CSV fictif. À connecter à votre backend plus tard.</p></div><div class="actions"><button class="btn" onclick="closeModal('reportModal')">Fermer</button><button class="btn primary" onclick="fakeExport()">Exporter CSV</button></div></div></div>

  <script>
    const THEMES = {
      dark:{
        '--bg':'#0f172a',
        '--panel':'#111827',
        '--muted':'#1f2937',
        '--card':'#0b1220',
        '--ink':'#e5e7eb',
        '--ink-dim':'#9ca3af',
        '--brand':'#22d3ee',
        '--accent':'#a78bfa',
        '--ok':'#10b981',
        '--warn':'#f59e0b',
        '--bad':'#ef4444',
        '--shadow':'0 10px 25px rgba(0,0,0,.25), 0 1px 0 rgba(255,255,255,.03) inset'
      },
      light:{
        '--bg':'#f1f5f9',
        '--panel':'#ffffff',
        '--muted':'#e2e8f0',
        '--card':'#f8fafc',
        '--ink':'#0f172a',
        '--ink-dim':'#475569',
        '--brand':'#0ea5e9',
        '--accent':'#6366f1',
        '--ok':'#059669',
        '--warn':'#d97706',
        '--bad':'#dc2626',
        '--shadow':'0 12px 28px rgba(15,23,42,.12), 0 1px 0 rgba(15,23,42,.04) inset'
      }
    };
    const FOCUSABLE_SELECTOR = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
    const INTERVENTION_TYPE_LABELS = {
      correctif:'Correctif',
      curatif:'Curatif',
      preventif:'Préventif',
      amelioration:'Amélioration',
      securite:'Sécurité'
    };
    const STATUS_CLASS_MAP = {
      'En attente':'warn',
      'En cours':'warn',
      'À surveiller':'bad',
      'Terminée':'ok'
    };
    let currentTheme = 'dark';
    let activeModal = null;
    let lastFocusedElement = null;
    let currentInterventionRow = null;
    let currentParcRow = null;
    let equipmentModalMode = 'create';
    let currentSparePartIndex = null;
    let currentPreventifRow = null;
    let currentPreventifPlanKey = '';
    let preventifFormLocked = false;
    let currentContactRow = null;
    let contactModalMode = 'create';
    let currentPersonnelRow = null;
    let personnelModalMode = 'create';
    let lastDiRequester = '';
    let lastDiRequesterId = '';
    let uniqueIdCounter = 0;
    const preventifDataStore = {};
    const ATTACHMENT_CONTEXTS = {
      di:{
        attachments:[],
        cameraStream:null,
        inputId:'diAttachmentInput',
        uploadButtonId:'diUploadButton',
        listId:'diAttachmentList',
        cameraButtonId:'diCameraButton',
        previewId:'diCameraPreview',
        videoId:'diCameraVideo',
        captureButtonId:'diCaptureBtn',
        closeCameraButtonId:'diCloseCameraBtn',
        emptyText:'Aucune pièce jointe pour le moment.',
        objectUrls:[]
      },
      intervention:{
        attachments:[],
        cameraStream:null,
        inputId:'interventionAttachmentInput',
        uploadButtonId:'interventionUploadButton',
        listId:'interventionAttachmentList',
        cameraButtonId:'interventionCameraButton',
        previewId:'interventionCameraPreview',
        videoId:'interventionCameraVideo',
        captureButtonId:'interventionCaptureBtn',
        closeCameraButtonId:'interventionCloseCameraBtn',
        emptyText:'Aucune pièce jointe pour le moment.',
        objectUrls:[]
      },
      preventifDocs:{
        attachments:[],
        cameraStream:null,
        inputId:'preventifDocInput',
        uploadButtonId:'preventifDocUpload',
        listId:'preventifDocList',
        emptyText:'Aucun document ajouté.',
        objectUrls:[]
      },
      preventifPhotos:{
        attachments:[],
        cameraStream:null,
        inputId:'preventifPhotoInput',
        uploadButtonId:'preventifPhotoUpload',
        listId:'preventifPhotoList',
        cameraButtonId:'preventifPhotoCameraButton',
        previewId:'preventifPhotoPreview',
        videoId:'preventifPhotoVideo',
        captureButtonId:'preventifPhotoCapture',
        closeCameraButtonId:'preventifPhotoClose',
        emptyText:'Aucune photo ajoutée.',
        objectUrls:[]
      }
    };
    const SPARE_PART_STATUS = {
      ordered:{label:'Commandée', tagClass:'warn'},
      used:{label:'Utilisée', tagClass:'ok'}
    };
    let spareParts = [
      {reference:'RB-0001', designation:'Kit roulements broche', ot:'DI-1024', machine:'DMU 70', status:'ordered', quantity:1, date:'2025-09-18', note:'Commande urgente fournisseur AirTech'},
      {reference:'FL-0450', designation:'Filtre air KAESER', ot:'DI-1026', machine:'Compresseur KAESER', status:'used', quantity:1, date:'2025-09-22', note:'Installé lors de l’intervention'}
    ];
    let sparePartModalContext = {source:'pieces', defaults:{}, index:null};

    function switchSection(e){
      e.preventDefault();
      const trigger = e.currentTarget;
      const target = trigger.getAttribute('data-target');
      document.querySelectorAll('.menu [data-target]').forEach(item=>{
        const isActive = item.getAttribute('data-target') === target;
        item.classList.toggle('active', isActive);
        item.setAttribute('aria-pressed', isActive ? 'true' : 'false');
      });
      document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
      document.getElementById(target).classList.add('active');
    }

    function applyTheme(theme,{persist=true}={}){
      if(!THEMES[theme]) theme='dark';
      currentTheme = theme;
      const root = document.documentElement;
      root.dataset.theme = theme;
      const vars = THEMES[theme];
      Object.entries(vars).forEach(([key,val])=>root.style.setProperty(key,val));
      if(persist){
        try{ localStorage.setItem('gmao-theme', theme); }catch(_e){/* storage non critique */}
      }
      updateThemeToggle();
    }

    function updateThemeToggle(){
      const btn = document.getElementById('themeToggle');
      if(!btn) return;
      const isLight = currentTheme === 'light';
      btn.setAttribute('aria-pressed', isLight ? 'true' : 'false');
      btn.textContent = isLight ? '🌞 Mode clair' : '🌙 Mode sombre';
    }

    function toggleTheme(){
      const next = currentTheme === 'dark' ? 'light' : 'dark';
      applyTheme(next);
    }

    function openModal(id){
      const modal = document.getElementById(id);
      if(!modal) return;
      lastFocusedElement = document.activeElement instanceof HTMLElement ? document.activeElement : null;
      modal.classList.add('open');
      modal.setAttribute('aria-hidden','false');
      activeModal = modal;
      document.body.style.overflow = 'hidden';
      const focusable = modal.querySelectorAll(FOCUSABLE_SELECTOR);
      if(focusable.length){
        focusable[0].focus({preventScroll:true});
      }
    }

    function closeModal(id){
      const modal = document.getElementById(id);
      if(!modal) return;
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden','true');
      if(id === 'interventionModal'){
        currentInterventionRow = null;
        resetAttachmentContext('intervention');
        renderInterventionPieces('');
      }else if(id === 'diModal'){
        resetDemandModal();
      }else if(id === 'preventifDetailModal'){
        savePreventifAttachments(currentPreventifPlanKey);
        closeCamera('preventifPhotos');
        const docCtx = getAttachmentContext('preventifDocs');
        if(docCtx){
          docCtx.onUpdate = null;
          docCtx.planKey = '';
        }
        const photoCtx = getAttachmentContext('preventifPhotos');
        if(photoCtx){
          photoCtx.onUpdate = null;
          photoCtx.planKey = '';
        }
        currentPreventifRow = null;
        currentPreventifPlanKey = '';
        preventifFormLocked = false;
      }else if(id === 'pieceModal'){
        resetSparePartModal();
      }else if(id === 'spareSearchModal'){
        resetSpareSearchModal();
      }
      if(activeModal === modal) activeModal = null;
      if(!document.querySelector('.modal.open')){
        document.body.style.overflow = '';
        if(lastFocusedElement && document.body.contains(lastFocusedElement)){
          lastFocusedElement.focus({preventScroll:true});
        }
        lastFocusedElement = null;
      }
    }

    function closeActiveModal(){
      if(activeModal){
        closeModal(activeModal.id);
      }
    }

    function getAttachmentContext(key){
      return ATTACHMENT_CONTEXTS[key];
    }

    function addAttachments(contextKey, files){
      if(isPreventifAttachmentLocked(contextKey)) return;
      const ctx = getAttachmentContext(contextKey);
      if(!ctx || !files || !files.length) return;
      ctx.attachments = ctx.attachments.concat(files);
      renderAttachments(contextKey);
      if(typeof ctx.onUpdate === 'function'){
        ctx.onUpdate(ctx);
      }
    }

    function renderAttachments(contextKey){
      const ctx = getAttachmentContext(contextKey);
      if(!ctx) return;
      const list = document.getElementById(ctx.listId);
      if(!list) return;
      list.innerHTML = '';
      if(Array.isArray(ctx.objectUrls) && ctx.objectUrls.length){
        ctx.objectUrls.forEach(url=>URL.revokeObjectURL(url));
        ctx.objectUrls = [];
      }
      if(!ctx.attachments.length){
        const empty = document.createElement('li');
        empty.className = 'attachment-empty';
        empty.textContent = ctx.emptyText;
        list.appendChild(empty);
        return;
      }
      const locked = isPreventifAttachmentLocked(contextKey);
      ctx.attachments.forEach((file,index)=>{
        const li = document.createElement('li');
        li.className = 'attachment-item';
        const info = document.createElement('div');
        info.className = 'attachment-info';
        const nameText = file.name || `Photo ${index+1}.jpg`;
        const canPreview = typeof Blob !== 'undefined' && file instanceof Blob;
        const href = canPreview && typeof URL !== 'undefined' ? URL.createObjectURL(file) : '';
        if(href){
          ctx.objectUrls.push(href);
        }
        let titleEl;
        if(href){
          const link = document.createElement('a');
          link.className = 'attachment-name attachment-link';
          link.textContent = nameText;
          link.href = href;
          link.target = '_blank';
          link.rel = 'noopener';
          link.setAttribute('title', `Ouvrir ${nameText} dans un nouvel onglet`);
          titleEl = link;
        }else{
          const span = document.createElement('span');
          span.className = 'attachment-name';
          span.textContent = nameText;
          titleEl = span;
        }
        info.appendChild(titleEl);
        if(file.size){
          const meta = document.createElement('span');
          meta.className = 'attachment-meta';
          const sizeKB = Math.max(1, Math.round(file.size/1024));
          meta.textContent = `${sizeKB} Ko`;
          info.appendChild(meta);
        }
        const remove = document.createElement('button');
        remove.type = 'button';
        remove.className = 'attachment-remove';
        remove.setAttribute('data-remove-index', index);
        remove.setAttribute('aria-label', `Retirer ${nameText}`);
        remove.textContent = '✖️';
        remove.disabled = locked;
        if(locked){
          remove.setAttribute('aria-disabled','true');
        }
        li.appendChild(info);
        li.appendChild(remove);
        list.appendChild(li);
      });
    }

    function removeAttachment(contextKey, index){
      if(isPreventifAttachmentLocked(contextKey)) return;
      const ctx = getAttachmentContext(contextKey);
      if(!ctx) return;
      if(index<0 || index>=ctx.attachments.length) return;
      ctx.attachments.splice(index,1);
      renderAttachments(contextKey);
      if(typeof ctx.onUpdate === 'function'){
        ctx.onUpdate(ctx);
      }
    }

    async function openCamera(contextKey){
      if(isPreventifAttachmentLocked(contextKey)) return;
      const ctx = getAttachmentContext(contextKey);
      if(!ctx) return;
      const preview = document.getElementById(ctx.previewId);
      const video = document.getElementById(ctx.videoId);
      const toggleBtn = document.getElementById(ctx.cameraButtonId);
      if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
        alert('La capture depuis la caméra n’est pas supportée sur cet appareil.');
        return;
      }
      try{
        ctx.cameraStream = await navigator.mediaDevices.getUserMedia({video:true});
        if(video){
          video.srcObject = ctx.cameraStream;
        }
        if(preview){
          preview.hidden = false;
        }
        if(toggleBtn){
          toggleBtn.setAttribute('aria-expanded','true');
          toggleBtn.textContent = '📷 Fermer la caméra';
        }
      }catch(err){
        console.error('Impossible d’ouvrir la caméra', err);
        alert('Impossible d’accéder à la caméra. Vérifiez les autorisations.');
      }
    }

    function closeCamera(contextKey){
      const ctx = getAttachmentContext(contextKey);
      if(!ctx) return;
      const preview = document.getElementById(ctx.previewId);
      const video = document.getElementById(ctx.videoId);
      const toggleBtn = document.getElementById(ctx.cameraButtonId);
      if(ctx.cameraStream){
        ctx.cameraStream.getTracks().forEach(track=>track.stop());
        ctx.cameraStream = null;
      }
      if(video){
        video.srcObject = null;
      }
      if(preview){
        preview.hidden = true;
      }
      if(toggleBtn){
        toggleBtn.setAttribute('aria-expanded','false');
        toggleBtn.textContent = '📷 Prendre une photo';
      }
    }

    function capturePhoto(contextKey){
      if(isPreventifAttachmentLocked(contextKey)) return;
      const ctx = getAttachmentContext(contextKey);
      if(!ctx) return;
      const video = document.getElementById(ctx.videoId);
      if(!video || !ctx.cameraStream || video.readyState < 2){
        return;
      }
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const context2d = canvas.getContext('2d');
      if(!context2d){
        return;
      }
      context2d.drawImage(video, 0, 0, canvas.width, canvas.height);
      canvas.toBlob(blob=>{
        if(!blob) return;
        const timestamp = new Date().toISOString().replace(/[:.]/g,'-');
        let file;
        try{
          file = new File([blob], `photo-${timestamp}.jpg`, {type:'image/jpeg'});
        }catch(_e){
          file = blob;
          file.name = `photo-${timestamp}.jpg`;
        }
        addAttachments(contextKey, [file]);
      }, 'image/jpeg', 0.92);
    }

    function resetAttachmentContext(contextKey){
      const ctx = getAttachmentContext(contextKey);
      if(!ctx) return;
      ctx.attachments = [];
      const input = document.getElementById(ctx.inputId);
      if(input){
        input.value = '';
      }
      if(Array.isArray(ctx.objectUrls) && ctx.objectUrls.length){
        ctx.objectUrls.forEach(url=>URL.revokeObjectURL(url));
        ctx.objectUrls = [];
      }
      renderAttachments(contextKey);
      closeCamera(contextKey);
      if(typeof ctx.onUpdate === 'function'){
        ctx.onUpdate(ctx);
      }
    }

    function resetDemandModal(){
      resetAttachmentContext('di');
      const modal = document.getElementById('diModal');
      if(!modal) return;
      modal.querySelectorAll('input:not([type="file"]):not([type="checkbox"]), textarea').forEach(el=>{
        if(el.type === 'date'){
          el.value = '';
        }else{
          el.value = '';
        }
      });
      modal.querySelectorAll('select').forEach(select=>{ select.selectedIndex = 0; });
      const stopCheckbox = document.getElementById('diMachineStop');
      if(stopCheckbox){
        stopCheckbox.checked = false;
      }
    }

    function submitDiModal(){
      const demandeurSelect = document.getElementById('diDemandeur');
      if(demandeurSelect){
        lastDiRequesterId = demandeurSelect.value;
        lastDiRequester = getPersonnelLabelById(lastDiRequesterId) || '';
      }
      closeModal('diModal');
    }

    function setupAttachmentHandlers(contextKey){
      const ctx = getAttachmentContext(contextKey);
      if(!ctx) return;
      const input = document.getElementById(ctx.inputId);
      const uploadButton = document.getElementById(ctx.uploadButtonId);
      const list = document.getElementById(ctx.listId);
      const cameraButton = document.getElementById(ctx.cameraButtonId);
      const captureButton = document.getElementById(ctx.captureButtonId);
      const closeCameraBtn = document.getElementById(ctx.closeCameraButtonId);

      if(uploadButton && input){
        uploadButton.addEventListener('click', ()=>input.click());
      }

      if(input){
        input.addEventListener('change', evt=>{
          const files = Array.from(evt.target.files || []);
          addAttachments(contextKey, files);
          input.value = '';
        });
      }

      if(list){
        list.addEventListener('click', evt=>{
          const btn = evt.target.closest('button[data-remove-index]');
          if(btn){
            evt.preventDefault();
            const index = Number(btn.getAttribute('data-remove-index'));
            removeAttachment(contextKey, index);
          }
        });
      }

      if(cameraButton){
        cameraButton.addEventListener('click', evt=>{
          evt.preventDefault();
          const ctxRef = getAttachmentContext(contextKey);
          if(ctxRef && ctxRef.cameraStream){
            closeCamera(contextKey);
          }else{
            openCamera(contextKey);
          }
        });
      }

      if(captureButton){
        captureButton.addEventListener('click', evt=>{
          evt.preventDefault();
          capturePhoto(contextKey);
        });
      }

      if(closeCameraBtn){
        closeCameraBtn.addEventListener('click', evt=>{
          evt.preventDefault();
          closeCamera(contextKey);
        });
      }

      renderAttachments(contextKey);
    }

    function getSparePartStatusMeta(status){
      return SPARE_PART_STATUS[status] || {label:status || '—', tagClass:''};
    }

    function formatDisplayDate(value){
      if(!value) return '—';
      const parts = value.split('-');
      if(parts.length === 3){
        return `${parts[2]}/${parts[1]}/${parts[0]}`;
      }
      return value;
    }

    function toIsoDate(value){
      if(!value) return '';
      if(/^\d{4}-\d{2}-\d{2}$/.test(value)) return value;
      const parts = value.split('/');
      if(parts.length === 3){
        const [day, month, year] = parts;
        if(day.length === 2 && month.length === 2 && year.length === 4){
          return `${year}-${month}-${day}`;
        }
      }
      return '';
    }

    function getParcMachineNames(){
      const names = new Set();
      document.querySelectorAll('#tblParc tr').forEach(tr=>{
        const ds = tr.dataset || {};
        const modele = (ds.modele || '').trim();
        const machine = (ds.machine || '').trim();
        if(modele) names.add(modele);
        if(machine) names.add(machine);
      });
      return Array.from(names).filter(Boolean).sort((a,b)=>a.localeCompare(b,'fr',{sensitivity:'base'}));
    }

    function populatePreventifMachineOptions(currentValue){
      const select = document.getElementById('preventif-machine');
      if(!select) return;
      const machines = getParcMachineNames();
      select.innerHTML = '';
      const placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.textContent = 'Sélectionner une machine…';
      select.appendChild(placeholder);
      machines.forEach(name=>{
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        select.appendChild(option);
      });
      if(currentValue && !machines.includes(currentValue)){
        const extra = document.createElement('option');
        extra.value = currentValue;
        extra.textContent = currentValue;
        select.appendChild(extra);
      }
      setSelectValue(select, currentValue || '');
    }

    function computePreventifEtatMeta(prochain){
      if(!prochain){
        return {label:'', className:''};
      }
      const dueDate = new Date(prochain);
      if(Number.isNaN(dueDate.getTime())){
        return {label:'', className:''};
      }
      const today = new Date();
      today.setHours(0,0,0,0);
      dueDate.setHours(0,0,0,0);
      if(dueDate < today){
        return {label:'En retard', className:'bad'};
      }
      return {label:"À l'heure", className:'ok'};
    }

    function refreshPreventifEtatField(){
      const prochainInput = document.getElementById('preventif-prochain');
      const prochain = prochainInput ? prochainInput.value : '';
      const meta = computePreventifEtatMeta(prochain);
      const etatInput = document.getElementById('preventif-etat');
      if(etatInput){
        etatInput.value = meta.label || '';
      }
      return meta;
    }

    function applyPreventifEtatToRow(row, meta){
      if(!row || !meta) return;
      const ds = row.dataset || {};
      const label = meta.label || '';
      ds.etat = label;
      ds.etatClass = meta.className || '';
      const cell = row.cells[5];
      if(cell){
        cell.innerHTML = '';
        const span = document.createElement('span');
        span.className = ['status', meta.className || ''].filter(Boolean).join(' ');
        span.textContent = label || '—';
        cell.appendChild(span);
      }
    }

    function isPreventifAttachmentLocked(contextKey){
      return preventifFormLocked && (contextKey === 'preventifDocs' || contextKey === 'preventifPhotos');
    }

    function setPreventifAttachmentsDisabled(contextKey, disabled){
      const ctx = getAttachmentContext(contextKey);
      if(!ctx) return;
      ['inputId','uploadButtonId','cameraButtonId','captureButtonId','closeCameraButtonId'].forEach(key=>{
        const id = ctx[key];
        if(!id) return;
        const el = document.getElementById(id);
        if(!el) return;
        if(key === 'inputId'){
          el.disabled = disabled;
        }else{
          el.disabled = disabled;
          if(disabled){
            el.setAttribute('aria-disabled','true');
          }else{
            el.removeAttribute('aria-disabled');
          }
        }
      });
    }

    function setPreventifFormLocked(locked,{restore=false}={}){
      preventifFormLocked = !!locked;
      const form = document.getElementById('preventifForm');
      if(form){
        const controls = form.querySelectorAll('input, select, textarea');
        controls.forEach(control=>{
          if(control.id === 'preventif-etat'){
            control.readOnly = true;
            control.disabled = true;
            return;
          }
          if(control.tagName === 'TEXTAREA'){
            control.readOnly = locked;
            control.disabled = locked;
          }else if(control.tagName === 'SELECT'){
            control.disabled = locked;
          }else{
            control.readOnly = locked;
            control.disabled = locked;
          }
        });
      }
      const submit = document.getElementById('preventifModalSubmit');
      if(submit){
        submit.disabled = locked;
      }
      const editBtn = document.getElementById('preventifEditButton');
      if(editBtn){
        editBtn.textContent = locked ? 'Modifier' : 'Annuler';
        editBtn.setAttribute('aria-pressed', locked ? 'false' : 'true');
      }
      setPreventifAttachmentsDisabled('preventifDocs', locked);
      setPreventifAttachmentsDisabled('preventifPhotos', locked);
      renderAttachments('preventifDocs');
      renderAttachments('preventifPhotos');
      if(locked && restore && currentPreventifRow){
        populatePreventifFormFromRow(currentPreventifRow, {focus:false});
      }
    }

    function getSpareFilters(){
      const searchInput = document.getElementById('piecesSearch');
      const statusSelect = document.getElementById('piecesStatusFilter');
      return {
        search: searchInput ? searchInput.value.trim().toLowerCase() : '',
        status: statusSelect ? statusSelect.value : ''
      };
    }

    function getFilteredSpareParts(){
      const {search, status} = getSpareFilters();
      return spareParts.filter(part=>{
        if(status && part.status !== status) return false;
        if(!search) return true;
        const haystack = [part.reference, part.designation, part.ot, part.machine, part.note]
          .map(v=>(v||'').toLowerCase())
          .join(' ');
        return haystack.includes(search);
      });
    }

    function createCell(value){
      const td = document.createElement('td');
      td.textContent = value ?? '—';
      return td;
    }

    function renderSpareParts(){
      const tbody = document.getElementById('tblPieces');
      if(!tbody) return;
      tbody.innerHTML = '';
      const filtered = getFilteredSpareParts();
      if(!filtered.length){
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 8;
        td.className = 'spare-empty-row';
        td.textContent = 'Aucune pièce ne correspond aux filtres actuels.';
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }
      filtered.forEach(part=>{
        const tr = document.createElement('tr');
        tr.classList.add('clickable');
        tr.setAttribute('role','button');
        tr.tabIndex = 0;
        const labelParts = [part.reference, part.designation].filter(Boolean).join(' – ');
        if(labelParts){
          tr.setAttribute('aria-label', `Voir la pièce ${labelParts}`);
        }
        const index = spareParts.indexOf(part);
        tr.dataset.index = index >= 0 ? String(index) : '';
        const statusMeta = getSparePartStatusMeta(part.status);
        const displayDate = formatDisplayDate(part.date);
        tr.dataset.reference = part.reference || '';
        tr.dataset.designation = part.designation || '';
        tr.dataset.ot = part.ot || '';
        tr.dataset.machine = part.machine || '';
        tr.dataset.status = part.status || '';
        tr.dataset.statusLabel = statusMeta.label || '';
        tr.dataset.statusClass = statusMeta.tagClass || '';
        tr.dataset.quantity = part.quantity != null ? String(part.quantity) : '';
        tr.dataset.date = part.date || '';
        tr.dataset.dateDisplay = displayDate;
        tr.dataset.note = part.note || '';

        tr.appendChild(createCell(part.reference || '—'));
        tr.appendChild(createCell(part.designation || '—'));
        tr.appendChild(createCell(part.ot || '—'));
        tr.appendChild(createCell(part.machine || '—'));
        const statusCell = document.createElement('td');
        const statusTag = document.createElement('span');
        statusTag.className = ['tag', statusMeta.tagClass].filter(Boolean).join(' ');
        statusTag.textContent = statusMeta.label;
        statusCell.appendChild(statusTag);
        tr.appendChild(statusCell);
        tr.appendChild(createCell(part.quantity != null ? String(part.quantity) : '—'));
        tr.appendChild(createCell(displayDate));
        tr.appendChild(createCell(part.note || '—'));
        attachInteractiveRow(tr, openSparePartDetail);
        tbody.appendChild(tr);
      });
    }

    function buildSpareListItem(part){
      const li = document.createElement('li');
      li.className = 'attachment-item spare-item';
      const index = spareParts.indexOf(part);
      const statusMeta = getSparePartStatusMeta(part.status);
      const formattedDate = formatDisplayDate(part.date);
      if(index >= 0){
        li.dataset.index = String(index);
      }else{
        li.dataset.index = '';
      }
      li.dataset.reference = part.reference || '';
      li.dataset.designation = part.designation || '';
      li.dataset.ot = part.ot || '';
      li.dataset.machine = part.machine || '';
      li.dataset.status = part.status || '';
      li.dataset.statusLabel = statusMeta.label || '';
      li.dataset.statusClass = statusMeta.tagClass || '';
      li.dataset.quantity = part.quantity != null ? String(part.quantity) : '';
      li.dataset.date = part.date || '';
      li.dataset.dateDisplay = formattedDate;
      li.dataset.note = part.note || '';

      const main = document.createElement('div');
      main.className = 'spare-item-main';
      const title = document.createElement('span');
      title.className = 'spare-item-title';
      title.textContent = part.designation || 'Pièce détachée';
      main.appendChild(title);

      const details = [];
      if(part.quantity != null) details.push(`${part.quantity}×`);
      if(part.reference) details.push(part.reference);
      if(part.machine) details.push(part.machine);
      if(formattedDate !== '—') details.push(formattedDate);
      if(details.length){
        const meta = document.createElement('span');
        meta.className = 'spare-item-meta';
        meta.textContent = details.join(' • ');
        main.appendChild(meta);
      }

      if(part.note){
        const note = document.createElement('span');
        note.className = 'spare-item-note';
        note.textContent = part.note;
        main.appendChild(note);
      }

      const actions = document.createElement('div');
      actions.className = 'spare-item-actions';
      const status = document.createElement('span');
      status.className = ['tag', statusMeta.tagClass].filter(Boolean).join(' ');
      status.textContent = statusMeta.label;
      actions.appendChild(status);

      li.appendChild(main);
      li.appendChild(actions);

      return {li, index, actions};
    }

    function renderInterventionPieces(ot){
      const list = document.getElementById('interventionPiecesList');
      const empty = document.getElementById('interventionPiecesEmpty');
      if(!list) return;
      list.innerHTML = '';
      const items = ot ? spareParts.filter(part=>part.ot === ot) : [];
      if(!items.length){
        if(empty) empty.hidden = false;
        return;
      }
      if(empty) empty.hidden = true;
      items.forEach(part=>{
        const {li, index, actions} = buildSpareListItem(part);
        li.setAttribute('role', 'button');
        li.tabIndex = 0;
        const labelParts = [part.reference, part.designation].filter(Boolean).join(' – ');
        if(labelParts){
          li.setAttribute('aria-label', `Voir la pièce ${labelParts}`);
        }
        if(index >= 0 && actions){
          const removeBtn = document.createElement('button');
          removeBtn.type = 'button';
          removeBtn.className = 'attachment-remove';
          const removeLabel = part.designation || part.reference;
          removeBtn.setAttribute('aria-label', removeLabel ? `Retirer ${removeLabel}` : 'Retirer cette pièce');
          removeBtn.textContent = '✖️';
          removeBtn.addEventListener('click', evt=>{
            evt.stopPropagation();
            deleteSparePart(index);
          });
          actions.appendChild(removeBtn);
        }
        attachInteractiveRow(li, openSparePartDetail);
        list.appendChild(li);
      });
    }

    function renderSpareSearchResults(query){
      const list = document.getElementById('spareSearchList');
      const empty = document.getElementById('spareSearchEmpty');
      if(!list) return;
      const normalized = (query || '').trim().toLowerCase();
      list.innerHTML = '';
      const results = spareParts.filter(part=>{
        if(!normalized) return true;
        const haystack = [part.reference, part.designation, part.machine, part.note, part.ot]
          .map(value=>(value || '').toLowerCase())
          .join(' ');
        return haystack.includes(normalized);
      });
      if(!results.length){
        if(empty) empty.hidden = false;
        return;
      }
      if(empty) empty.hidden = true;
      results.forEach(part=>{
        const {li, index} = buildSpareListItem(part);
        li.setAttribute('role', 'button');
        li.tabIndex = 0;
        const labelParts = [part.reference, part.designation].filter(Boolean).join(' – ');
        if(labelParts){
          li.setAttribute('aria-label', `Sélectionner la pièce ${labelParts}`);
        }
        const handleSelect = ()=>assignSparePartToCurrentIntervention(index);
        li.addEventListener('click', evt=>{
          evt.preventDefault();
          handleSelect();
        });
        li.addEventListener('keydown', evt=>{
          if(evt.key === 'Enter' || evt.key === ' '){
            evt.preventDefault();
            handleSelect();
          }
        });
        list.appendChild(li);
      });
    }

    function resetSpareSearchModal(){
      const input = document.getElementById('spareSearchInput');
      if(input) input.value = '';
      const list = document.getElementById('spareSearchList');
      if(list) list.innerHTML = '';
      const empty = document.getElementById('spareSearchEmpty');
      if(empty) empty.hidden = true;
    }

    function assignSparePartToCurrentIntervention(index){
      const numericIndex = Number(index);
      if(Number.isNaN(numericIndex) || numericIndex < 0 || numericIndex >= spareParts.length){
        return;
      }
      const part = spareParts[numericIndex];
      if(!part) return;
      const diInput = document.getElementById('interventionDi');
      const machineInput = document.getElementById('interventionMachine');
      const diValue = (diInput?.value || '').trim();
      if(!diValue){
        alert('Aucune DI n’est associée à cette intervention.');
        return;
      }
      const machineValue = (machineInput?.value || '').trim();
      part.ot = diValue;
      if(machineValue){
        part.machine = machineValue;
      }
      if(part.status !== 'used'){
        part.status = 'used';
      }
      renderSpareParts();
      renderInterventionPieces(diValue);
      fermerRecherchePiece();
    }

    function openSpareSearchModal(){
      const diInput = document.getElementById('interventionDi');
      const diValue = (diInput?.value || '').trim();
      if(!diValue){
        alert('Aucune intervention sélectionnée.');
        return;
      }
      resetSpareSearchModal();
      renderSpareSearchResults('');
      openModal('spareSearchModal');
      const searchInput = document.getElementById('spareSearchInput');
      if(searchInput){
        requestAnimationFrame(()=>searchInput.focus({preventScroll:true}));
      }
    }

    function ouvrirRecherchePiece(){
      openSpareSearchModal();
    }

    function fermerRecherchePiece(){
      closeModal('spareSearchModal');
    }

    function resetSparePartModal(){
      sparePartModalContext = {source:'pieces', defaults:{}, index:null};
      currentSparePartIndex = null;
      const form = document.getElementById('pieceForm');
      if(form) form.reset();
      const modal = document.getElementById('pieceModal');
      if(modal){
        modal.setAttribute('aria-label', 'Ajouter une pièce détachée');
      }
      const title = document.getElementById('pieceModalTitle');
      if(title){
        title.textContent = 'Nouvelle pièce détachée';
      }
      const submit = document.getElementById('pieceModalSubmit');
      if(submit){
        submit.textContent = 'Enregistrer';
      }
      const info = document.getElementById('pieceContextInfo');
      if(info){
        info.textContent = 'Associer une pièce détachée au stock ou à une intervention.';
      }
    }

    function openSparePartModal(source='pieces', defaults={}){
      const index = typeof defaults.index === 'number' && defaults.index >= 0 ? defaults.index : null;
      sparePartModalContext = {source, defaults, index};
      currentSparePartIndex = index;
      const form = document.getElementById('pieceForm');
      if(form) form.reset();
      const modal = document.getElementById('pieceModal');
      if(modal){
        modal.setAttribute('aria-label', index != null ? 'Modifier une pièce détachée' : 'Ajouter une pièce détachée');
      }
      const title = document.getElementById('pieceModalTitle');
      if(title){
        title.textContent = index != null ? 'Modifier une pièce détachée' : 'Nouvelle pièce détachée';
      }
      const submit = document.getElementById('pieceModalSubmit');
      if(submit){
        submit.textContent = index != null ? 'Mettre à jour' : 'Enregistrer';
      }
      const referenceInput = document.getElementById('pieceReference');
      const designationInput = document.getElementById('pieceDesignation');
      const diInput = document.getElementById('pieceDi');
      const machineInput = document.getElementById('pieceMachine');
      const statusSelect = document.getElementById('pieceStatus');
      const quantityInput = document.getElementById('pieceQuantity');
      const dateInput = document.getElementById('pieceDate');
      const noteInput = document.getElementById('pieceNote');
      const today = new Date().toISOString().slice(0,10);
      if(referenceInput) referenceInput.value = defaults.reference || '';
      if(designationInput) designationInput.value = defaults.designation || '';
      if(diInput) diInput.value = defaults.ot || '';
      if(machineInput) machineInput.value = defaults.machine || '';
      if(statusSelect){
        const fallbackStatus = source === 'intervention' ? 'used' : 'ordered';
        const nextStatus = defaults.status && SPARE_PART_STATUS[defaults.status] ? defaults.status : fallbackStatus;
        statusSelect.value = nextStatus;
      }
      if(quantityInput){
        const qty = defaults.quantity != null ? defaults.quantity : 1;
        quantityInput.value = qty;
      }
      if(dateInput) dateInput.value = defaults.date || today;
      if(noteInput) noteInput.value = defaults.note || '';
      const info = document.getElementById('pieceContextInfo');
      if(info){
        if(defaults.ot){
          info.textContent = `Intervention liée : ${defaults.ot}${defaults.machine ? ` • ${defaults.machine}` : ''}`;
        }else{
          info.textContent = 'Associer une pièce détachée au stock ou à une intervention.';
        }
      }
      openModal('pieceModal');
      if(referenceInput){
        requestAnimationFrame(()=>referenceInput.focus({preventScroll:true}));
      }
    }

    function saveSparePart(){
      const reference = (document.getElementById('pieceReference')?.value || '').trim();
      const designation = (document.getElementById('pieceDesignation')?.value || '').trim();
      const ot = (document.getElementById('pieceDi')?.value || '').trim();
      const machine = (document.getElementById('pieceMachine')?.value || '').trim();
      let status = document.getElementById('pieceStatus')?.value || 'ordered';
      const quantityRaw = document.getElementById('pieceQuantity')?.value;
      const date = document.getElementById('pieceDate')?.value || '';
      const note = (document.getElementById('pieceNote')?.value || '').trim();

      if(!designation){
        alert('Merci de renseigner la désignation de la pièce.');
        return;
      }

      let quantity = parseInt(quantityRaw, 10);
      if(Number.isNaN(quantity) || quantity <= 0){
        quantity = 1;
      }

      if(!SPARE_PART_STATUS[status]){
        status = 'ordered';
      }

      const partData = {reference, designation, ot, machine, status, quantity, date, note};
      const index = typeof sparePartModalContext.index === 'number' ? sparePartModalContext.index : null;
      if(index != null && spareParts[index]){
        spareParts[index] = partData;
      }else{
        spareParts.push(partData);
      }
      renderSpareParts();
      let targetOt = '';
      if(currentInterventionRow){
        targetOt = currentInterventionRow.dataset.ot || '';
      }else if(partData.ot){
        targetOt = partData.ot;
      }else if(sparePartModalContext.defaults.ot){
        targetOt = sparePartModalContext.defaults.ot;
      }
      renderInterventionPieces(targetOt);
      closeModal('pieceModal');
      resetSparePartModal();
    }

    // Simple global filter across visible table bodies
    function globalFilter(q){
      q = (q||'').toLowerCase();
      document.querySelectorAll('tbody').forEach(tb=>{
        tb.querySelectorAll('tr').forEach(tr=>{
          const hit = tr.innerText.toLowerCase().includes(q);
          tr.style.display = hit ? '' : 'none';
        });
      });
    }

    function filterTable(tbodyId, q, cols){
      q = (q||'').toLowerCase();
      const rows = document.getElementById(tbodyId).rows;
      for(const tr of rows){
        if(!q){ tr.style.display=''; continue; }
        let hit=false;
        (cols||[...tr.cells].map((_,i)=>i)).forEach(i=>{
          const cell = tr.cells[i];
          if(cell && cell.innerText.toLowerCase().includes(q)) hit=true;
        });
        tr.style.display = hit?'':'none';
      }
    }

    function filterStatus(tbodyId, status){
      const rows = document.getElementById(tbodyId).rows;
      for(const tr of rows){
        const st = (tr.getAttribute('data-status')||'').toLowerCase();
        tr.style.display = !status || st===status ? '' : 'none';
      }
    }

    function setDetailText(id, value){
      const el = document.getElementById(id);
      if(!el) return;
      const text = value!=null ? String(value).trim() : '';
      el.textContent = text ? text : '—';
    }

    function setDetailBadge(id, baseClass, extraClass, label){
      const el = document.getElementById(id);
      if(!el) return;
      const text = label!=null ? String(label).trim() : '';
      el.textContent = text ? text : '—';
      const classes = [baseClass];
      if(extraClass){
        classes.push(extraClass);
      }
      el.className = classes.join(' ');
    }

    function setSelectValue(select, value){
      if(!select) return;
      const options = Array.from(select.options || []);
      const hasValue = options.some(opt=>opt.value === value);
      if(hasValue){
        select.value = value;
      }else if(options.length){
        const placeholder = options.find(opt=>opt.value === '');
        select.value = placeholder ? '' : options[0].value;
      }
    }

    function generatePersonnelId(){
      uniqueIdCounter += 1;
      return `pers-${Date.now().toString(36)}-${uniqueIdCounter}`;
    }

    function getPersonnelRows(){
      return Array.from(document.querySelectorAll('#tblPersonnel tr.clickable'));
    }

    function getPersonnelOptions(){
      return getPersonnelRows().map(row=>{
        const ds = row.dataset || {};
        if(!ds.personnelId){
          ds.personnelId = generatePersonnelId();
        }
        const labelParts = [ds.prenom, ds.nom].filter(Boolean).map(part=>part.trim()).filter(Boolean);
        let label = labelParts.join(' ').trim();
        if(!label && ds.email){
          label = ds.email;
        }
        if(!label){
          const cells = Array.from(row.cells || []);
          label = cells.slice(0,2).map(td=>td?.innerText?.trim()||'').filter(Boolean).join(' ').trim();
        }
        if(!label){
          label = ds.personnelId;
        }
        return {id: ds.personnelId, label, data:{...ds}};
      }).filter(option=>option.id);
    }

    function getPersonnelLabelById(id){
      if(!id) return '';
      const rows = getPersonnelRows();
      for(const row of rows){
        const ds = row.dataset || {};
        if((ds.personnelId || '') === id){
          const parts = [ds.prenom, ds.nom].filter(Boolean).map(part=>part.trim()).filter(Boolean);
          if(parts.length){
            return parts.join(' ');
          }
          if(ds.email){
            return ds.email;
          }
          const cells = Array.from(row.cells || []);
          const cellLabel = cells.slice(0,2).map(td=>td?.innerText?.trim()||'').filter(Boolean).join(' ').trim();
          if(cellLabel){
            return cellLabel;
          }
          return id;
        }
      }
      return '';
    }

    function populatePersonnelSelect(select,{placeholder='Sélectionner un demandeur…',filter}={}){
      if(!select) return;
      const previousValue = select.value;
      select.innerHTML = '';
      const placeholderOption = document.createElement('option');
      placeholderOption.value = '';
      placeholderOption.textContent = placeholder;
      select.appendChild(placeholderOption);
      let options = getPersonnelOptions();
      if(typeof filter === 'function'){
        options = options.filter(option=>{
          try{
            return filter(option);
          }catch(_error){
            return true;
          }
        });
      }
      options.forEach(({id,label})=>{
        const option = document.createElement('option');
        option.value = id;
        option.textContent = label || id;
        select.appendChild(option);
      });
      if(previousValue){
        setSelectValue(select, previousValue);
      }
    }

    function populateInterventionTypeSelect(select,{includePlaceholder=false,placeholder='Sélectionner un type…'}={}){
      if(!select) return;
      const previousValue = select.value;
      select.innerHTML = '';
      if(includePlaceholder){
        const placeholderOption = document.createElement('option');
        placeholderOption.value = '';
        placeholderOption.textContent = placeholder;
        select.appendChild(placeholderOption);
      }
      Object.entries(INTERVENTION_TYPE_LABELS).forEach(([value,label])=>{
        const option = document.createElement('option');
        option.value = value;
        option.textContent = label;
        select.appendChild(option);
      });
      if(previousValue){
        setSelectValue(select, previousValue);
      }
    }

    function refreshDemandeurOptions(){
      populatePersonnelSelect(document.getElementById('diDemandeur'));
      populatePersonnelSelect(document.getElementById('interventionDemandeur'));
      populatePersonnelSelect(document.getElementById('interventionIntervenant'),{
        placeholder:'Sélectionner un intervenant…',
        filter:option=>{
          const poste = (option?.data?.poste || '').toLowerCase();
          return poste.includes('technicien');
        }
      });
    }

    function attachInteractiveRow(tr, handler){
      if(!tr || typeof handler !== 'function') return;
      tr.addEventListener('click', ()=>handler(tr));
      tr.addEventListener('keydown', evt=>{
        if(evt.key==='Enter' || evt.key===' '){
          evt.preventDefault();
          handler(tr);
        }
      });
    }

    function setupInterventionRows(){
      document.querySelectorAll('#tblDI tr').forEach(tr=>{
        attachInteractiveRow(tr, openInterventionDetail);
      });
    }

    function setupParcRows(){
      document.querySelectorAll('#tblParc tr.clickable').forEach(tr=>{
        attachInteractiveRow(tr, openParcDetail);
      });
    }

    function openParcDetail(row){
      currentParcRow = row;
      const ds = row.dataset || {};
      setDetailText('parcDetailZone', ds.zone);
      setDetailText('parcDetailMachine', ds.machine);
      setDetailText('parcDetailFabricant', ds.fabricant);
      setDetailText('parcDetailModele', ds.modele);
      setDetailText('parcDetailSerie', ds.serie);
      setDetailText('parcDetailAnnee', ds.annee);
      openModal('parcDetailModal');
    }

    function getEquipmentFields(){
      return {
        zone:document.getElementById('equip-zone'),
        machine:document.getElementById('equip-machine'),
        fabricant:document.getElementById('equip-fabricant'),
        modele:document.getElementById('equip-modele'),
        serie:document.getElementById('equip-serial'),
        annee:document.getElementById('equip-annee')
      };
    }

    function resetEquipmentForm(){
      const form = document.getElementById('equipForm');
      if(form) form.reset();
    }

    function openEquipmentForm(mode='create', defaults={}, row=null){
      equipmentModalMode = mode;
      currentParcRow = mode === 'edit' ? row : null;
      const modal = document.getElementById('equipModal');
      if(modal){
        modal.setAttribute('aria-label', mode === 'edit' ? 'Modifier un équipement' : 'Ajouter un équipement');
      }
      const title = document.getElementById('equipModalTitle');
      if(title){
        title.textContent = mode === 'edit' ? 'Modifier équipement' : 'Ajouter équipement';
      }
      const submit = document.getElementById('equipModalSubmit');
      if(submit){
        submit.textContent = mode === 'edit' ? 'Mettre à jour' : 'Enregistrer';
      }
      resetEquipmentForm();
      const fields = getEquipmentFields();
      if(fields.zone) fields.zone.value = defaults.zone || '';
      if(fields.machine) fields.machine.value = defaults.machine || '';
      if(fields.fabricant) fields.fabricant.value = defaults.fabricant || '';
      if(fields.modele) fields.modele.value = defaults.modele || '';
      if(fields.serie) fields.serie.value = defaults.serie || '';
      if(fields.annee) fields.annee.value = defaults.annee || '';
      openModal('equipModal');
      const focusTarget = fields.machine || fields.zone;
      if(focusTarget){
        requestAnimationFrame(()=>focusTarget.focus({preventScroll:true}));
      }
    }

    function gatherEquipmentValues(){
      const fields = getEquipmentFields();
      return {
        zone:(fields.zone?.value || '').trim(),
        machine:(fields.machine?.value || '').trim(),
        fabricant:(fields.fabricant?.value || '').trim(),
        modele:(fields.modele?.value || '').trim(),
        serie:(fields.serie?.value || '').trim(),
        annee:(fields.annee?.value || '').trim()
      };
    }

    function updateEquipmentRow(row, values){
      const ds = row.dataset;
      ds.zone = values.zone;
      ds.machine = values.machine;
      ds.fabricant = values.fabricant;
      ds.modele = values.modele;
      ds.serie = values.serie;
      ds.annee = values.annee;
      const cells = row.cells;
      if(cells[0]) cells[0].textContent = values.zone || '—';
      if(cells[1]) cells[1].textContent = values.machine || '—';
      if(cells[2]) cells[2].textContent = values.fabricant || '—';
      if(cells[3]) cells[3].textContent = values.modele || '—';
      if(cells[4]) cells[4].textContent = values.serie || '—';
      if(cells[5]) cells[5].textContent = values.annee || '—';
      const labelMachine = values.machine || 'l’équipement';
      row.setAttribute('aria-label', `Voir le détail de ${labelMachine}`);
    }

    function submitEquipmentForm(){
      const values = gatherEquipmentValues();
      if(!values.machine){
        alert('Merci de renseigner le nom de la machine.');
        return;
      }
      if(equipmentModalMode === 'edit' && currentParcRow){
        updateEquipmentRow(currentParcRow, values);
      }else{
        const tbody = document.getElementById('tblParc');
        if(!tbody){
          closeModal('equipModal');
          return;
        }
        const tr = document.createElement('tr');
        tr.classList.add('clickable');
        tr.setAttribute('role', 'button');
        tr.tabIndex = 0;
        updateEquipmentRow(tr, values);
        ['zone','machine','fabricant','modele','serie','annee'].forEach((key,index)=>{
          const td = tr.cells[index] || tr.appendChild(document.createElement('td'));
          td.textContent = values[key] || '—';
        });
        attachInteractiveRow(tr, openParcDetail);
        tbody.appendChild(tr);
      }
      closeModal('equipModal');
      resetEquipmentForm();
      equipmentModalMode = 'create';
      currentParcRow = null;
    }

    function beginEditEquipment(){
      if(!currentParcRow) return;
      const ds = currentParcRow.dataset || {};
      closeModal('parcDetailModal');
      openEquipmentForm('edit', {
        zone: ds.zone || '',
        machine: ds.machine || '',
        fabricant: ds.fabricant || '',
        modele: ds.modele || '',
        serie: ds.serie || '',
        annee: ds.annee || ''
      }, currentParcRow);
    }

    function openSparePartDetail(row){
      const indexRaw = row.dataset ? row.dataset.index : undefined;
      const parsedIndex = indexRaw !== undefined && indexRaw !== '' ? Number(indexRaw) : NaN;
      currentSparePartIndex = Number.isNaN(parsedIndex) ? null : parsedIndex;
      const ds = row.dataset || {};
      const displayDate = ds.dateDisplay || formatDisplayDate(ds.date || '');
      setDetailText('pieceDetailReference', ds.reference);
      setDetailText('pieceDetailDesignation', ds.designation);
      setDetailText('pieceDetailDi', ds.ot);
      setDetailText('pieceDetailMachine', ds.machine);
      const statusLabel = ds.statusLabel || ds.status;
      setDetailBadge('pieceDetailStatus', 'tag', ds.statusClass || '', statusLabel);
      setDetailText('pieceDetailQuantity', ds.quantity);
      setDetailText('pieceDetailDate', displayDate);
      setDetailText('pieceDetailNote', ds.note);
      openModal('pieceDetailModal');
    }

    function beginEditSparePart(){
      if(currentSparePartIndex == null) return;
      const part = spareParts[currentSparePartIndex];
      if(!part) return;
      closeModal('pieceDetailModal');
      openSparePartModal('pieces', {...part, index: currentSparePartIndex});
    }

    function deleteSparePart(index){
      const numericIndex = Number(index);
      if(Number.isNaN(numericIndex) || numericIndex < 0 || numericIndex >= spareParts.length){
        return;
      }
      const part = spareParts[numericIndex];
      const label = part?.designation || part?.reference || '';
      const message = label ? `Supprimer la pièce « ${label} » ?` : 'Supprimer cette pièce ?';
      if(typeof window !== 'undefined' && !window.confirm(message)){
        return;
      }
      spareParts.splice(numericIndex, 1);
      if(currentSparePartIndex === numericIndex){
        currentSparePartIndex = null;
      }else if(currentSparePartIndex != null && currentSparePartIndex > numericIndex){
        currentSparePartIndex -= 1;
      }
      renderSpareParts();
      const targetOt = currentInterventionRow ? (currentInterventionRow.dataset.ot || '') : (part?.ot || '');
      renderInterventionPieces(targetOt);
      if(activeModal && activeModal.id === 'pieceDetailModal'){
        closeModal('pieceDetailModal');
      }
    }

    function setupPreventifRows(){
      document.querySelectorAll('#tblPrev tr.clickable').forEach(tr=>{
        attachInteractiveRow(tr, openPreventifDetail);
      });
    }

    function getPreventifRowKey(row){
      if(!row) return '';
      const ds = row.dataset || {};
      const plan = (ds.plan || '').trim();
      if(plan){
        return plan;
      }
      if(!ds.preventifKey){
        ds.preventifKey = `preventif-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,6)}`;
      }
      return ds.preventifKey;
    }

    function ensurePreventifRecord(key){
      if(!key) return null;
      if(!preventifDataStore[key]){
        preventifDataStore[key] = {documents:[], photos:[], description:''};
      }
      const record = preventifDataStore[key];
      if(!Array.isArray(record.documents)) record.documents = [];
      if(!Array.isArray(record.photos)) record.photos = [];
      record.description = typeof record.description === 'string' ? record.description : '';
      return record;
    }

    function loadPreventifAttachments(planKey){
      if(!planKey) return;
      const record = ensurePreventifRecord(planKey) || {documents:[], photos:[]};
      const docCtx = getAttachmentContext('preventifDocs');
      if(docCtx){
        docCtx.planKey = planKey;
        docCtx.onUpdate = ctx=>savePreventifAttachments(ctx.planKey);
        docCtx.attachments = Array.isArray(record.documents) ? record.documents.slice() : [];
        docCtx.objectUrls = [];
        const input = document.getElementById(docCtx.inputId);
        if(input){
          input.value = '';
        }
        renderAttachments('preventifDocs');
      }
      const photoCtx = getAttachmentContext('preventifPhotos');
      if(photoCtx){
        closeCamera('preventifPhotos');
        photoCtx.planKey = planKey;
        photoCtx.onUpdate = ctx=>savePreventifAttachments(ctx.planKey);
        photoCtx.attachments = Array.isArray(record.photos) ? record.photos.slice() : [];
        photoCtx.objectUrls = [];
        const input = document.getElementById(photoCtx.inputId);
        if(input){
          input.value = '';
        }
        renderAttachments('preventifPhotos');
      }
    }

    function savePreventifAttachments(planKey){
      if(!planKey) return;
      const record = ensurePreventifRecord(planKey);
      if(!record) return;
      const docCtx = getAttachmentContext('preventifDocs');
      if(docCtx && docCtx.planKey === planKey){
        record.documents = docCtx.attachments.slice();
      }
      const photoCtx = getAttachmentContext('preventifPhotos');
      if(photoCtx && photoCtx.planKey === planKey){
        record.photos = photoCtx.attachments.slice();
      }
    }

    function populatePreventifFormFromRow(row,{focus=true}={}){
      if(!row) return;
      const form = document.getElementById('preventifForm');
      if(form){
        form.reset();
      }
      const planKey = getPreventifRowKey(row);
      currentPreventifPlanKey = planKey;
      const ds = row.dataset || {};
      const record = ensurePreventifRecord(planKey);
      if(record && !record.description && ds.description){
        record.description = ds.description;
      }
      const planInput = document.getElementById('preventif-plan');
      const periodiciteSelect = document.getElementById('preventif-periodicite');
      const dernierInput = document.getElementById('preventif-dernier');
      const prochainInput = document.getElementById('preventif-prochain');
      const etatInput = document.getElementById('preventif-etat');
      const descriptionInput = document.getElementById('preventif-description');
      const dernierIso = ds.dernierIso || toIsoDate(ds.dernier || '');
      const prochainIso = ds.prochainIso || toIsoDate(ds.prochain || '');
      if(dernierIso && !ds.dernierIso){
        ds.dernierIso = dernierIso;
      }
      if(prochainIso && !ds.prochainIso){
        ds.prochainIso = prochainIso;
      }
      if(planInput) planInput.value = ds.plan || '';
      populatePreventifMachineOptions(ds.machine || '');
      if(periodiciteSelect) setSelectValue(periodiciteSelect, ds.periodicite || '');
      if(dernierInput) dernierInput.value = dernierIso;
      if(prochainInput) prochainInput.value = prochainIso;
      const etatMeta = computePreventifEtatMeta(prochainIso);
      if(etatInput){
        etatInput.value = etatMeta.label || '';
      }
      applyPreventifEtatToRow(row, etatMeta);
      if(descriptionInput) descriptionInput.value = (record?.description || ds.description || '');
      loadPreventifAttachments(planKey);
      if(focus && planInput && !preventifFormLocked){
        requestAnimationFrame(()=>planInput.focus({preventScroll:true}));
      }
    }

    function openPreventifDetail(row){
      currentPreventifRow = row;
      const ds = row.dataset || {};
      const planKey = getPreventifRowKey(row);
      currentPreventifPlanKey = planKey;
      const isExistingPlan = Boolean((ds.plan || '').trim());
      setPreventifFormLocked(isExistingPlan);
      populatePreventifFormFromRow(row, {focus:!isExistingPlan});
      const editBtn = document.getElementById('preventifEditButton');
      if(editBtn){
        editBtn.hidden = !isExistingPlan;
        editBtn.disabled = !isExistingPlan;
      }
      openModal('preventifDetailModal');
    }

    function updatePreventifRow(row, values){
      const ds = row.dataset;
      ds.plan = values.plan;
      ds.machine = values.machine;
      ds.periodicite = values.periodicite;
      ds.dernier = values.displayDernier;
      ds.dernierIso = values.dernier;
      ds.prochain = values.displayProchain;
      ds.prochainIso = values.prochain;
      ds.etat = values.etat;
      ds.etatClass = values.etatClass;
      ds.description = values.description || '';
      if(ds.preventifKey && ds.preventifKey !== values.plan){
        delete ds.preventifKey;
      }
      const cells = row.cells;
      if(cells[0]) cells[0].textContent = values.plan || '—';
      if(cells[1]) cells[1].textContent = values.machine || '—';
      if(cells[2]) cells[2].textContent = values.periodicite || '—';
      if(cells[3]) cells[3].textContent = values.displayDernier || '—';
      if(cells[4]) cells[4].textContent = values.displayProchain || '—';
      if(cells[5]){
        cells[5].innerHTML = '';
        const span = document.createElement('span');
        span.className = ['status', values.etatClass].filter(Boolean).join(' ');
        span.textContent = values.etat || '—';
        cells[5].appendChild(span);
      }
      const label = values.plan ? `Voir le plan préventif ${values.plan}` : 'Voir le plan préventif';
      row.setAttribute('aria-label', label);
    }

    function submitPreventifForm(){
      if(!currentPreventifRow){
        closeModal('preventifDetailModal');
        return;
      }
      const plan = (document.getElementById('preventif-plan')?.value || '').trim();
      const machine = (document.getElementById('preventif-machine')?.value || '').trim();
      if(!plan || !machine){
        alert('Merci de renseigner au minimum le plan et la machine.');
        return;
      }
      const periodicite = (document.getElementById('preventif-periodicite')?.value || '').trim();
      const dernier = document.getElementById('preventif-dernier')?.value || '';
      const prochain = document.getElementById('preventif-prochain')?.value || '';
      const description = (document.getElementById('preventif-description')?.value || '').trim();
      const displayDernier = formatDisplayDate(dernier);
      const displayProchain = formatDisplayDate(prochain);
      const etatMeta = computePreventifEtatMeta(prochain);
      const etat = etatMeta.label || '';
      const etatClass = etatMeta.className || '';
      const values = {plan, machine, periodicite, dernier, prochain, displayDernier, displayProchain, etat, etatClass, description};
      updatePreventifRow(currentPreventifRow, values);
      const docCtx = getAttachmentContext('preventifDocs');
      const photoCtx = getAttachmentContext('preventifPhotos');
      const previousKey = currentPreventifPlanKey;
      const newKey = plan || previousKey;
      if(previousKey && newKey && newKey !== previousKey){
        const existing = ensurePreventifRecord(previousKey) || {documents:[], photos:[], description:''};
        const target = ensurePreventifRecord(newKey);
        target.documents = docCtx ? docCtx.attachments.slice() : existing.documents.slice();
        target.photos = photoCtx ? photoCtx.attachments.slice() : existing.photos.slice();
        target.description = description;
        if(previousKey !== newKey){
          delete preventifDataStore[previousKey];
        }
        if(docCtx){
          docCtx.planKey = newKey;
        }
        if(photoCtx){
          photoCtx.planKey = newKey;
        }
        currentPreventifPlanKey = newKey;
      }else{
        const record = ensurePreventifRecord(newKey);
        if(record){
          record.description = description;
          record.documents = docCtx ? docCtx.attachments.slice() : [];
          record.photos = photoCtx ? photoCtx.attachments.slice() : [];
        }
      }
      savePreventifAttachments(currentPreventifPlanKey || newKey);
      closeModal('preventifDetailModal');
    }

    function deletePreventif(){
      if(!currentPreventifRow) return;
      const ds = currentPreventifRow.dataset || {};
      const planLabel = ds.plan ? ` ${ds.plan}` : '';
      if(!confirm(`Supprimer le plan préventif${planLabel} ?`)){
        return;
      }
      const key = currentPreventifPlanKey || getPreventifRowKey(currentPreventifRow);
      if(key && preventifDataStore[key]){
        delete preventifDataStore[key];
      }
      currentPreventifRow.remove();
      currentPreventifRow = null;
      currentPreventifPlanKey = '';
      closeModal('preventifDetailModal');
    }

    function createPreventifDemand(){
      if(!currentPreventifRow) return;
      const ds = currentPreventifRow.dataset || {};
      const key = currentPreventifPlanKey || getPreventifRowKey(currentPreventifRow);
      savePreventifAttachments(key);
      closeModal('preventifDetailModal');
      resetDemandModal();
      const machine = ds.machine || '';
      const machineSelect = document.getElementById('diMachine');
      if(machineSelect && machine){
        let option = Array.from(machineSelect.options || []).find(opt=>opt.value === machine);
        if(!option){
          option = document.createElement('option');
          option.value = machine;
          option.textContent = machine;
          machineSelect.appendChild(option);
        }
        setSelectValue(machineSelect, machine);
      }
      const typeSelect = document.getElementById('diType');
      if(typeSelect){
        setSelectValue(typeSelect, 'preventif');
      }
      const travauxTextarea = document.querySelector('#diModal textarea');
      const record = ensurePreventifRecord(key);
      if(travauxTextarea){
        const parts = [record?.description || ds.description || '']
          .map(part=>part.trim())
          .filter(Boolean);
        travauxTextarea.value = parts.join(' — ');
      }
      openModal('diModal');
    }

    function setupPersonnelRows(){
      document.querySelectorAll('#tblPersonnel tr.clickable').forEach(tr=>{
        attachInteractiveRow(tr, openPersonnelDetail);
      });
    }

    function openPersonnelDetail(row){
      currentPersonnelRow = row;
      const ds = row.dataset || {};
      setDetailText('personnelDetailNom', ds.nom);
      setDetailText('personnelDetailPrenom', ds.prenom);
      setDetailText('personnelDetailPoste', ds.poste);
      setDetailText('personnelDetailTelephone', ds.telephone);
      setDetailText('personnelDetailEmail', ds.email);
      openModal('personnelDetailModal');
    }

    function openPersonnelForm(mode='create', defaults={}, row=null){
      personnelModalMode = mode;
      currentPersonnelRow = mode === 'edit' ? row : null;
      const modal = document.getElementById('personnelModal');
      if(modal){
        modal.setAttribute('aria-label', mode === 'edit' ? 'Modifier un personnel' : 'Créer un personnel');
      }
      const title = document.getElementById('personnelModalTitle');
      if(title){
        title.textContent = mode === 'edit' ? 'Modifier un personnel' : 'Nouveau personnel';
      }
      const submit = document.getElementById('personnelModalSubmit');
      if(submit){
        submit.textContent = mode === 'edit' ? 'Mettre à jour' : 'Enregistrer';
      }
      const form = document.getElementById('personnelForm');
      if(form) form.reset();
      const lastnameInput = document.getElementById('personnel-lastname');
      const firstnameInput = document.getElementById('personnel-firstname');
      const roleInput = document.getElementById('personnel-role');
      const phoneInput = document.getElementById('personnel-phone');
      const emailInput = document.getElementById('personnel-email');
      if(lastnameInput) lastnameInput.value = defaults.nom || defaults.lastName || '';
      if(firstnameInput) firstnameInput.value = defaults.prenom || defaults.firstName || '';
      if(roleInput) roleInput.value = defaults.poste || defaults.role || '';
      if(phoneInput) phoneInput.value = defaults.telephone || defaults.phone || '';
      if(emailInput) emailInput.value = defaults.email || '';
      openModal('personnelModal');
      if(lastnameInput){
        requestAnimationFrame(()=>lastnameInput.focus({preventScroll:true}));
      }
    }

    function gatherPersonnelValues(){
      const lastName = (document.getElementById('personnel-lastname')?.value || '').trim();
      const firstName = (document.getElementById('personnel-firstname')?.value || '').trim();
      const role = (document.getElementById('personnel-role')?.value || '').trim();
      const phone = (document.getElementById('personnel-phone')?.value || '').trim();
      const email = (document.getElementById('personnel-email')?.value || '').trim();
      return {lastName, firstName, role, phone, email};
    }

    function updatePersonnelRow(row, values){
      const ds = row.dataset;
      if(!ds.personnelId){
        ds.personnelId = generatePersonnelId();
      }
      ds.nom = values.lastName;
      ds.prenom = values.firstName;
      ds.poste = values.role;
      ds.telephone = values.phone;
      ds.email = values.email;
      const columns = [values.lastName, values.firstName, values.role, values.phone, values.email];
      columns.forEach((text, index)=>{
        const cell = row.cells[index] || row.appendChild(document.createElement('td'));
        cell.textContent = text || '—';
      });
      const fullName = [values.firstName, values.lastName].filter(Boolean).join(' ').trim();
      const label = fullName ? `Voir la fiche de ${fullName}` : 'Voir la fiche personnel';
      row.setAttribute('aria-label', label);
    }

    function submitPersonnelForm(){
      const values = gatherPersonnelValues();
      if(!values.lastName || !values.firstName){
        alert('Merci de renseigner au minimum le nom et le prénom.');
        return;
      }
      const editingRow = personnelModalMode === 'edit' ? currentPersonnelRow : null;
      if(personnelModalMode === 'edit' && currentPersonnelRow){
        updatePersonnelRow(currentPersonnelRow, values);
      }else{
        const tbody = document.getElementById('tblPersonnel');
        if(!tbody){
          closeModal('personnelModal');
          return;
        }
        const tr = document.createElement('tr');
        tr.classList.add('clickable');
        tr.setAttribute('role','button');
        tr.tabIndex = 0;
        updatePersonnelRow(tr, values);
        attachInteractiveRow(tr, openPersonnelDetail);
        tbody.appendChild(tr);
      }
      refreshDemandeurOptions();
      closeModal('personnelModal');
      const form = document.getElementById('personnelForm');
      if(form) form.reset();
      personnelModalMode = 'create';
      if(editingRow){
        openPersonnelDetail(editingRow);
      }else{
        currentPersonnelRow = null;
      }
    }

    function beginEditPersonnel(){
      if(!currentPersonnelRow) return;
      const ds = currentPersonnelRow.dataset || {};
      closeModal('personnelDetailModal');
      openPersonnelForm('edit', {
        nom: ds.nom || '',
        prenom: ds.prenom || '',
        poste: ds.poste || '',
        telephone: ds.telephone || '',
        email: ds.email || ''
      }, currentPersonnelRow);
    }

    function deletePersonnel(){
      if(!currentPersonnelRow) return;
      const ds = currentPersonnelRow.dataset || {};
      const label = [ds.prenom, ds.nom].filter(Boolean).join(' ').trim();
      const message = label ? `Supprimer la fiche de ${label} ?` : 'Supprimer cette fiche personnel ?';
      if(typeof window !== 'undefined' && !window.confirm(message)){
        return;
      }
      const row = currentPersonnelRow;
      currentPersonnelRow = null;
      if(row && row.parentElement){
        row.parentElement.removeChild(row);
      }else if(row){
        row.remove();
      }
      refreshDemandeurOptions();
      closeModal('personnelDetailModal');
    }

    function setupContactRows(){
      document.querySelectorAll('#tblContacts tr.clickable').forEach(tr=>{
        attachInteractiveRow(tr, openContactDetail);
      });
    }

    function openContactDetail(row){
      currentContactRow = row;
      const ds = row.dataset || {};
      setDetailText('contactDetailEntreprise', ds.entreprise);
      setDetailText('contactDetailActivite', ds.activite);
      setDetailText('contactDetailNom', ds.contact);
      setDetailText('contactDetailEmail', ds.email);
      setDetailText('contactDetailTelephone', ds.telephone);
      openModal('contactDetailModal');
    }

    function openContactForm(mode='create', defaults={}, row=null){
      contactModalMode = mode;
      currentContactRow = mode === 'edit' ? row : null;
      const modal = document.getElementById('contactModal');
      if(modal){
        modal.setAttribute('aria-label', mode === 'edit' ? 'Modifier un contact' : 'Créer un contact');
      }
      const title = document.getElementById('contactModalTitle');
      if(title){
        title.textContent = mode === 'edit' ? 'Modifier un contact' : 'Nouveau contact';
      }
      const submit = document.getElementById('contactModalSubmit');
      if(submit){
        submit.textContent = mode === 'edit' ? 'Mettre à jour' : 'Enregistrer';
      }
      const form = document.getElementById('contactForm');
      if(form) form.reset();
      const companyInput = document.getElementById('contact-company');
      const activityInput = document.getElementById('contact-activity');
      const nameInput = document.getElementById('contact-name');
      const emailInput = document.getElementById('contact-email');
      const phoneInput = document.getElementById('contact-phone');
      if(companyInput) companyInput.value = defaults.entreprise || defaults.company || '';
      if(activityInput) activityInput.value = defaults.activite || defaults.activity || '';
      if(nameInput) nameInput.value = defaults.contact || defaults.name || '';
      if(emailInput) emailInput.value = defaults.email || '';
      if(phoneInput) phoneInput.value = defaults.telephone || defaults.phone || '';
      openModal('contactModal');
      if(companyInput){
        requestAnimationFrame(()=>companyInput.focus({preventScroll:true}));
      }
    }

    function gatherContactValues(){
      const company = (document.getElementById('contact-company')?.value || '').trim();
      const activity = (document.getElementById('contact-activity')?.value || '').trim();
      const name = (document.getElementById('contact-name')?.value || '').trim();
      const email = (document.getElementById('contact-email')?.value || '').trim();
      const phone = (document.getElementById('contact-phone')?.value || '').trim();
      return {company, activity, name, email, phone};
    }

    function updateContactRow(row, values){
      const ds = row.dataset;
      ds.entreprise = values.company;
      ds.activite = values.activity;
      ds.contact = values.name;
      ds.email = values.email;
      ds.telephone = values.phone;
      const cells = row.cells;
      if(cells[0]) cells[0].textContent = values.company || '—';
      if(cells[1]) cells[1].textContent = values.activity || '—';
      if(cells[2]) cells[2].textContent = values.name || '—';
      if(cells[3]) cells[3].textContent = values.email || '—';
      if(cells[4]) cells[4].textContent = values.phone || '—';
      const label = values.company ? `Voir le contact ${values.company}` : 'Voir le contact';
      row.setAttribute('aria-label', label);
    }

    function submitContactForm(){
      const values = gatherContactValues();
      if(!values.company){
        alert('Merci de renseigner le nom de l’entreprise.');
        return;
      }
      if(contactModalMode === 'edit' && currentContactRow){
        updateContactRow(currentContactRow, values);
      }else{
        const tbody = document.getElementById('tblContacts');
        if(!tbody){
          closeModal('contactModal');
          return;
        }
        const tr = document.createElement('tr');
        tr.classList.add('clickable');
        tr.setAttribute('role','button');
        tr.tabIndex = 0;
        for(const text of [values.company, values.activity, values.name, values.email, values.phone]){
          const td = document.createElement('td');
          td.textContent = text || '—';
          tr.appendChild(td);
        }
        updateContactRow(tr, values);
        attachInteractiveRow(tr, openContactDetail);
        tbody.appendChild(tr);
      }
      closeModal('contactModal');
      contactModalMode = 'create';
      const form = document.getElementById('contactForm');
      if(form) form.reset();
      currentContactRow = null;
    }

    function beginEditContact(){
      if(!currentContactRow) return;
      const ds = currentContactRow.dataset || {};
      closeModal('contactDetailModal');
      openContactForm('edit', {
        entreprise: ds.entreprise || '',
        activite: ds.activite || '',
        contact: ds.contact || '',
        email: ds.email || '',
        telephone: ds.telephone || ''
      }, currentContactRow);
    }

    function openInterventionDetail(row){
      currentInterventionRow = row;
      const ds = row.dataset;
      resetAttachmentContext('intervention');
      const fields = {
        di:document.getElementById('interventionDi'),
        machine:document.getElementById('interventionMachine'),
        demandeur:document.getElementById('interventionDemandeur'),
        intervenant:document.getElementById('interventionIntervenant'),
        statut:document.getElementById('interventionStatut'),
        priorite:document.getElementById('interventionPriorite'),
        type:document.getElementById('interventionType'),
        description:document.getElementById('interventionDescription'),
        duree:document.getElementById('interventionDuree'),
        arret:document.getElementById('interventionArret'),
        resolution:document.getElementById('interventionResolution')
      };

      if(!fields.di) return;

      fields.di.value = ds.ot || '';
      fields.machine.value = ds.machine || '';
      if(fields.demandeur){
        const demandeurId = ds.demandeurId || lastDiRequesterId || '';
        setSelectValue(fields.demandeur, demandeurId);
        if(!fields.demandeur.value && ds.demandeur){
          const value = demandeurId || ds.demandeur;
          const exists = Array.from(fields.demandeur.options || []).some(opt=>opt.value === value);
          if(!exists){
            const customOption = document.createElement('option');
            customOption.value = value;
            customOption.textContent = ds.demandeur;
            fields.demandeur.appendChild(customOption);
          }
          setSelectValue(fields.demandeur, value);
        }
      }
      if(fields.intervenant){
        const intervenantId = ds.intervenantId || '';
        setSelectValue(fields.intervenant, intervenantId);
        if(!fields.intervenant.value && ds.intervenant){
          const value = intervenantId || ds.intervenant;
          const exists = Array.from(fields.intervenant.options || []).some(opt=>opt.value === value);
          if(!exists){
            const customOption = document.createElement('option');
            customOption.value = value;
            customOption.textContent = ds.intervenant;
            fields.intervenant.appendChild(customOption);
          }
          setSelectValue(fields.intervenant, value);
        }
      }
      setSelectValue(fields.statut, ds.statut || 'En attente');
      setSelectValue(fields.priorite, ds.priorite || 'P1');
      setSelectValue(fields.type, ds.typeIntervention || 'correctif');
      fields.description.value = ds.description || '';
      fields.duree.value = ds.tempsIntervention || '';
      fields.arret.value = ds.tempsArret || '';
      fields.resolution.value = ds.resolution || '';

      renderInterventionPieces(ds.ot || '');

      openModal('interventionModal');
      const focusTarget = fields.statut || fields.priorite || fields.type;
      if(focusTarget){
        requestAnimationFrame(()=>{
          focusTarget.focus({preventScroll:true});
        });
      }
    }

    function saveInterventionDetails(){
      if(!currentInterventionRow){
        closeModal('interventionModal');
        return;
      }
      const ds = currentInterventionRow.dataset;
      const statut = document.getElementById('interventionStatut').value;
      const priorite = document.getElementById('interventionPriorite').value;
      const demandeurSelect = document.getElementById('interventionDemandeur');
      const demandeurId = demandeurSelect ? demandeurSelect.value : '';
      const demandeurLabel = demandeurId ? (getPersonnelLabelById(demandeurId) || '') : '';
      const intervenantSelect = document.getElementById('interventionIntervenant');
      const intervenantId = intervenantSelect ? intervenantSelect.value : '';
      const intervenantLabel = intervenantId ? (getPersonnelLabelById(intervenantId) || '') : '';
      const type = document.getElementById('interventionType').value;
      const description = document.getElementById('interventionDescription').value.trim();
      const duree = document.getElementById('interventionDuree').value;
      const arret = document.getElementById('interventionArret').value;
      const resolution = document.getElementById('interventionResolution').value;
      const typeLabel = INTERVENTION_TYPE_LABELS[type] || type;

      ds.statut = statut;
      ds.status = statut;
      ds.priorite = priorite;
      ds.type = typeLabel;
      ds.demandeurId = demandeurId;
      ds.demandeur = demandeurId ? (demandeurLabel || ds.demandeur || '') : '';
      ds.intervenantId = intervenantId;
      ds.intervenant = intervenantId ? (intervenantLabel || ds.intervenant || '') : '';
      ds.typeIntervention = type;
      ds.description = description;
      ds.tempsIntervention = duree;
      ds.tempsArret = arret;
      ds.resolution = resolution;

      if(demandeurId){
        lastDiRequesterId = demandeurId;
        lastDiRequester = ds.demandeur;
      }

      currentInterventionRow.cells[2].innerText = typeLabel;
      currentInterventionRow.cells[3].innerText = priorite;
      const statusCell = currentInterventionRow.cells[4];
      if(statusCell){
        statusCell.innerHTML = '';
        const span = document.createElement('span');
        const statusClass = STATUS_CLASS_MAP[statut] || '';
        span.className = ['status', statusClass].filter(Boolean).join(' ');
        span.textContent = statut || '—';
        statusCell.appendChild(span);
      }

      closeModal('interventionModal');
    }

    function fakeExport(){
      const rows = [['DI','Machine','Priorité','Statut','Prévu'], ...Array.from(document.querySelectorAll('#tblDI tr')).map(tr=>[...tr.cells].slice(0,5).map(td=>td.innerText.trim()))];
      const csv = rows.map(r=>r.join(';')).join('\n');
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
        a.href = url; a.download = 'export_di.csv'; a.click();
      URL.revokeObjectURL(url);
    }

    function init(){
      let savedTheme = null;
      try{ savedTheme = localStorage.getItem('gmao-theme'); }catch(_e){ savedTheme = null; }
      applyTheme(savedTheme || 'dark', {persist:false});

      document.querySelectorAll('.modal').forEach(modal=>{
        modal.addEventListener('click', evt=>{
          if(evt.target === modal) closeModal(modal.id);
        });
      });

      setupInterventionRows();
      setupParcRows();
      setupPreventifRows();
      setupContactRows();
      setupPersonnelRows();

      ['di','intervention','preventifDocs','preventifPhotos'].forEach(setupAttachmentHandlers);

      refreshDemandeurOptions();
      populateInterventionTypeSelect(document.getElementById('interventionType'));
      populateInterventionTypeSelect(document.getElementById('diType'), {includePlaceholder:true});

      const pieceForm = document.getElementById('pieceForm');
      if(pieceForm){
        pieceForm.addEventListener('submit', evt=>{
          evt.preventDefault();
          saveSparePart();
        });
      }

      const equipForm = document.getElementById('equipForm');
      if(equipForm){
        equipForm.addEventListener('submit', evt=>{
          evt.preventDefault();
          submitEquipmentForm();
        });
      }

      const contactFormEl = document.getElementById('contactForm');
      if(contactFormEl){
        contactFormEl.addEventListener('submit', evt=>{
          evt.preventDefault();
          submitContactForm();
        });
      }

      const personnelFormEl = document.getElementById('personnelForm');
      if(personnelFormEl){
        personnelFormEl.addEventListener('submit', evt=>{
          evt.preventDefault();
          submitPersonnelForm();
        });
      }

      const preventifFormEl = document.getElementById('preventifForm');
      if(preventifFormEl){
        preventifFormEl.addEventListener('submit', evt=>{
          evt.preventDefault();
          submitPreventifForm();
        });
      }

      const preventifEditBtn = document.getElementById('preventifEditButton');
      if(preventifEditBtn){
        preventifEditBtn.addEventListener('click', ()=>{
          if(!currentPreventifRow) return;
          if(preventifFormLocked){
            setPreventifFormLocked(false);
            const planInput = document.getElementById('preventif-plan');
            if(planInput){
              requestAnimationFrame(()=>planInput.focus({preventScroll:true}));
            }
          }else{
            setPreventifFormLocked(true, {restore:true});
          }
        });
      }

      const preventifProchainInput = document.getElementById('preventif-prochain');
      if(preventifProchainInput){
        const updateEtat = ()=>{
          refreshPreventifEtatField();
        };
        preventifProchainInput.addEventListener('change', updateEtat);
        preventifProchainInput.addEventListener('input', updateEtat);
      }

      const addPieceBtn = document.getElementById('interventionAddPieceBtn');
      if(addPieceBtn){
        addPieceBtn.addEventListener('click', ()=>{
          const defaults = currentInterventionRow ? {
            ot: currentInterventionRow.dataset.ot || '',
            machine: currentInterventionRow.dataset.machine || '',
            status:'used'
          } : {status:'used'};
          openSparePartModal('intervention', defaults);
        });
      }

      const spareSearchInput = document.getElementById('spareSearchInput');
      if(spareSearchInput){
        spareSearchInput.addEventListener('input', evt=>{
          renderSpareSearchResults(evt.target.value);
        });
      }

      renderSpareParts();
      renderInterventionPieces('');

      document.addEventListener('keydown', evt=>{
        if(evt.key === 'Escape' && activeModal){
          evt.preventDefault();
          closeActiveModal();
        }else if(evt.key === 'Tab' && activeModal){
          const focusable = Array.from(activeModal.querySelectorAll(FOCUSABLE_SELECTOR)).filter(el=>!el.hasAttribute('disabled') && !el.getAttribute('aria-hidden'));
          if(!focusable.length) return;
          const first = focusable[0];
          const last = focusable[focusable.length-1];
          const active = document.activeElement;
          if(evt.shiftKey && active === first){
            evt.preventDefault();
            last.focus();
          }else if(!evt.shiftKey && active === last){
            evt.preventDefault();
            first.focus();
          }
        }
      });

    }

    if(document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', init);
    }else{
      init();
    }
  </script>
</body>
</html>


